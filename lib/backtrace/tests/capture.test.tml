// Tests for backtrace capture functionality
//
// NOTE: On Windows without frame pointers (default for optimized TML code),
// RtlCaptureStackBackTrace can only capture a limited number of frames.
// These tests are designed to work with this limitation.

use test
use backtrace::backtrace::Backtrace

// ============================================================================
// Basic Capture Tests
// ============================================================================

@test
func test_capture_returns_backtrace() -> I32 {
    let bt: Backtrace = Backtrace::capture()
    let count: I32 = bt.frame_count()
    // On Windows without frame pointers, we may only get 1-2 frames
    assert(count >= 0, "backtrace should not return negative")
    return 0
}

@test
func test_capture_from_skip() -> I32 {
    let bt1: Backtrace = Backtrace::capture()
    let bt2: Backtrace = Backtrace::capture_from(1)

    let count1: I32 = bt1.frame_count()
    let count2: I32 = bt2.frame_count()

    // Both should be non-negative
    assert(count1 >= 0, "capture should not return negative")
    assert(count2 >= 0, "capture_from should not return negative")
    return 0
}

// ============================================================================
// Formatting Tests
// ============================================================================

@test
func test_to_string_produces_output() -> I32 {
    let mut bt: Backtrace = Backtrace::capture()
    let s: Str = bt.to_string()
    let len: I64 = s.len()
    // Even with 0 frames, to_string produces some output
    assert(len > 0, "to_string should produce output")
    return 0
}
