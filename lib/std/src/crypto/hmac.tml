//! HMAC (Hash-based Message Authentication Code).
//!
//! HMAC provides message authentication using a secret key combined with a
//! cryptographic hash function. It verifies both data integrity and authenticity.
//!
//! # Supported Algorithms
//!
//! | Algorithm | Output Size | Notes |
//! |-----------|-------------|-------|
//! | HMAC-MD5 | 128 bits | Legacy only, not secure |
//! | HMAC-SHA1 | 160 bits | Deprecated |
//! | HMAC-SHA256 | 256 bits | Recommended |
//! | HMAC-SHA384 | 384 bits | Higher security |
//! | HMAC-SHA512 | 512 bits | Best for 64-bit platforms |
//!
//! # Examples
//!
//! ## One-shot HMAC
//!
//! ```tml
//! use std::crypto::hmac::{hmac_sha256}
//!
//! let mut mac: HmacDigest = hmac_sha256("secret-key", "message")
//! print("HMAC: {mac.to_hex()}\n")
//! mac.destroy()
//! ```

use std::crypto::hash::{HashAlgorithm}
use std::collections::Buffer

// ============================================================================
// FFI Function Declarations
// ============================================================================

@extern("crypto_hmac_sha256")
func ffi_crypto_hmac_sha256(key: Str, data: Str) -> *Unit

@extern("crypto_hmac_sha256_bytes")
func ffi_crypto_hmac_sha256_bytes(key_handle: *Unit, data_handle: *Unit) -> *Unit

@extern("crypto_hmac_sha512")
func ffi_crypto_hmac_sha512(key: Str, data: Str) -> *Unit

@extern("crypto_hmac_sha512_bytes")
func ffi_crypto_hmac_sha512_bytes(key_handle: *Unit, data_handle: *Unit) -> *Unit

@extern("crypto_hmac_sha384")
func ffi_crypto_hmac_sha384(key: Str, data: Str) -> *Unit

@extern("crypto_hmac_sha1")
func ffi_crypto_hmac_sha1(key: Str, data: Str) -> *Unit

@extern("crypto_hmac_md5")
func ffi_crypto_hmac_md5(key: Str, data: Str) -> *Unit

@extern("crypto_hmac_create")
func ffi_crypto_hmac_create(algorithm: Str, key: Str) -> *Unit

@extern("crypto_hmac_update_str")
func ffi_crypto_hmac_update_str(handle: *Unit, data: Str)

@extern("crypto_hmac_update_bytes")
func ffi_crypto_hmac_update_bytes(handle: *Unit, data_handle: *Unit)

@extern("crypto_hmac_digest")
func ffi_crypto_hmac_digest(handle: *Unit) -> *Unit

@extern("crypto_hmac_destroy")
func ffi_crypto_hmac_destroy(handle: *Unit)

@extern("crypto_bytes_to_hex")
func ffi_crypto_bytes_to_hex(handle: *Unit) -> Str

// ============================================================================
// Streaming HMAC Type
// ============================================================================

/// Streaming HMAC computation object.
///
/// Use this for computing HMACs of large data or data that arrives in chunks.
pub type Hmac {
    handle: *Unit
    finalized: Bool
}

impl Hmac {
    /// Creates a new Hmac object for the specified algorithm with a string key.
    pub func create(algorithm: HashAlgorithm, key: Str) -> Hmac {
        let algo_name: Str = algorithm.name()
        let handle: *Unit = ffi_crypto_hmac_create(algo_name, key)
        return Hmac {
            handle: handle,
            finalized: false,
        }
    }

    /// Updates the HMAC with string data.
    pub func update(mut this, data: Str) {
        if not this.finalized {
            ffi_crypto_hmac_update_str(this.handle, data)
        }
    }

    /// Updates the HMAC with binary data.
    pub func update_bytes(mut this, data: ref Buffer) {
        if not this.finalized {
            ffi_crypto_hmac_update_bytes(this.handle, data.handle)
        }
    }

    /// Finalizes the HMAC and returns the digest.
    ///
    /// After calling this method, the HMAC object cannot be used for further updates.
    pub func digest(mut this) -> HmacDigest {
        this.finalized = true
        let result_handle: *Unit = ffi_crypto_hmac_digest(this.handle)
        let buffer: Buffer = Buffer { handle: result_handle }
        return HmacDigest { data: buffer }
    }

    /// Frees the HMAC context resources.
    pub func destroy(mut this) {
        if this.handle != null {
            ffi_crypto_hmac_destroy(this.handle)
            this.handle = null
        }
    }
}

// ============================================================================
// HMAC Digest Type
// ============================================================================

/// An HMAC digest (the output of an HMAC computation).
pub type HmacDigest {
    data: Buffer
}

impl HmacDigest {
    /// Returns the digest as a hexadecimal string.
    pub func to_hex(this) -> Str {
        return ffi_crypto_bytes_to_hex(this.data.handle)
    }

    /// Returns the length of the digest in bytes.
    pub func len(this) -> I64 {
        return this.data.len()
    }

    /// Frees the digest resources.
    pub func destroy(mut this) {
        this.data.destroy()
    }
}

// ============================================================================
// One-shot HMAC functions
// ============================================================================

/// Computes HMAC-MD5.
///
/// **Warning**: MD5 is not recommended for security-sensitive applications.
pub func hmac_md5(key: Str, data: Str) -> HmacDigest {
    let handle: *Unit = ffi_crypto_hmac_md5(key, data)
    let buffer: Buffer = Buffer { handle: handle }
    return HmacDigest { data: buffer }
}

/// Computes HMAC-SHA1.
///
/// **Warning**: SHA-1 is deprecated. Prefer HMAC-SHA256 or better.
pub func hmac_sha1(key: Str, data: Str) -> HmacDigest {
    let handle: *Unit = ffi_crypto_hmac_sha1(key, data)
    let buffer: Buffer = Buffer { handle: handle }
    return HmacDigest { data: buffer }
}

/// Computes HMAC-SHA256.
///
/// This is the recommended HMAC function for most applications.
pub func hmac_sha256(key: Str, data: Str) -> HmacDigest {
    let handle: *Unit = ffi_crypto_hmac_sha256(key, data)
    let buffer: Buffer = Buffer { handle: handle }
    return HmacDigest { data: buffer }
}

/// Computes HMAC-SHA384.
pub func hmac_sha384(key: Str, data: Str) -> HmacDigest {
    let handle: *Unit = ffi_crypto_hmac_sha384(key, data)
    let buffer: Buffer = Buffer { handle: handle }
    return HmacDigest { data: buffer }
}

/// Computes HMAC-SHA512.
pub func hmac_sha512(key: Str, data: Str) -> HmacDigest {
    let handle: *Unit = ffi_crypto_hmac_sha512(key, data)
    let buffer: Buffer = Buffer { handle: handle }
    return HmacDigest { data: buffer }
}
