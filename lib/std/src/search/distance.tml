//! SIMD-optimized vector distance and similarity functions.
//!
//! Provides dot product, cosine similarity, euclidean distance, and
//! vector normalization for both F32 and F64 arrays. All functions
//! use auto-vectorized loops for SIMD performance.
//!
//! # F64 Functions
//!
//! ```tml
//! use std::search::distance::{dot_product, cosine_similarity}
//!
//! var a: [F64; 3] = [1.0, 2.0, 3.0]
//! var b: [F64; 3] = [4.0, 5.0, 6.0]
//! let dp = dot_product(&a[0], &b[0], 3)   // 32.0
//! ```
//!
//! # F32 Functions
//!
//! ```tml
//! use std::search::distance::{dot_product_f32, cosine_similarity_f32}
//!
//! var a: [F32; 3] = [1.0, 2.0, 3.0]
//! var b: [F32; 3] = [4.0, 5.0, 6.0]
//! let dp = dot_product_f32(&a[0], &b[0], 3)   // 32.0
//! ```

// ============================================================================
// F64 FFI Declarations
// ============================================================================

@extern("search_dot_product")
func ffi_dot_product(a: *F64, b: *F64, dim: I64) -> F64

@extern("search_cosine_similarity")
func ffi_cosine_similarity(a: *F64, b: *F64, dim: I64) -> F64

@extern("search_euclidean_distance")
func ffi_euclidean_distance(a: *F64, b: *F64, dim: I64) -> F64

@extern("search_norm")
func ffi_norm(v: *F64, dim: I64) -> F64

@extern("search_normalize")
func ffi_normalize(v: *F64, dim: I64) -> Unit

// ============================================================================
// F32 FFI Declarations
// ============================================================================

@extern("search_dot_product_f32")
func ffi_dot_product_f32(a: *F32, b: *F32, dim: I64) -> F32

@extern("search_cosine_similarity_f32")
func ffi_cosine_similarity_f32(a: *F32, b: *F32, dim: I64) -> F32

@extern("search_euclidean_distance_f32")
func ffi_euclidean_distance_f32(a: *F32, b: *F32, dim: I64) -> F32

@extern("search_l2_squared_f32")
func ffi_l2_squared_f32(a: *F32, b: *F32, dim: I64) -> F32

@extern("search_norm_f32")
func ffi_norm_f32(v: *F32, dim: I64) -> F32

@extern("search_normalize_f32")
func ffi_normalize_f32(v: *F32, dim: I64) -> Unit

// ============================================================================
// F64 Public API
// ============================================================================

/// Computes the dot product (inner product) of two F64 vectors.
///
/// @param a First vector (pointer to F64 array)
/// @param b Second vector (pointer to F64 array)
/// @param dim Number of dimensions
/// @returns Sum of element-wise products
pub func dot_product(a: *F64, b: *F64, dim: I64) -> F64 {
    return lowlevel { ffi_dot_product(a, b, dim) }
}

/// Computes cosine similarity between two F64 vectors.
///
/// Returns value in [-1, 1] where 1 means identical direction,
/// 0 means orthogonal, -1 means opposite direction.
///
/// @param a First vector
/// @param b Second vector
/// @param dim Number of dimensions
/// @returns Cosine similarity score
pub func cosine_similarity(a: *F64, b: *F64, dim: I64) -> F64 {
    return lowlevel { ffi_cosine_similarity(a, b, dim) }
}

/// Computes the Euclidean (L2) distance between two F64 vectors.
///
/// @param a First vector
/// @param b Second vector
/// @param dim Number of dimensions
/// @returns L2 distance (always >= 0)
pub func euclidean_distance(a: *F64, b: *F64, dim: I64) -> F64 {
    return lowlevel { ffi_euclidean_distance(a, b, dim) }
}

/// Computes the L2 norm (magnitude) of an F64 vector.
///
/// @param v Input vector
/// @param dim Number of dimensions
/// @returns L2 norm (always >= 0)
pub func norm(v: *F64, dim: I64) -> F64 {
    return lowlevel { ffi_norm(v, dim) }
}

/// Normalizes an F64 vector in place (makes it unit length).
///
/// After normalization, the vector has L2 norm of 1.0.
/// If the vector has zero magnitude, it is left unchanged.
///
/// @param v Vector to normalize (modified in place)
/// @param dim Number of dimensions
pub func normalize(v: *F64, dim: I64) -> Unit {
    lowlevel { ffi_normalize(v, dim) }
}

// ============================================================================
// F32 Public API
// ============================================================================

/// Computes the dot product (inner product) of two F32 vectors.
///
/// F32 operations are typically faster than F64 due to SIMD vectorization
/// processing twice as many elements per instruction.
///
/// @param a First vector (pointer to F32 array)
/// @param b Second vector (pointer to F32 array)
/// @param dim Number of dimensions
/// @returns Sum of element-wise products
pub func dot_product_f32(a: *F32, b: *F32, dim: I64) -> F32 {
    return lowlevel { ffi_dot_product_f32(a, b, dim) }
}

/// Computes cosine similarity between two F32 vectors.
///
/// Returns value in [-1, 1]. Used for measuring semantic similarity
/// between normalized embeddings.
///
/// @param a First vector
/// @param b Second vector
/// @param dim Number of dimensions
/// @returns Cosine similarity score
pub func cosine_similarity_f32(a: *F32, b: *F32, dim: I64) -> F32 {
    return lowlevel { ffi_cosine_similarity_f32(a, b, dim) }
}

/// Computes the Euclidean (L2) distance between two F32 vectors.
///
/// @param a First vector
/// @param b Second vector
/// @param dim Number of dimensions
/// @returns L2 distance (always >= 0)
pub func euclidean_distance_f32(a: *F32, b: *F32, dim: I64) -> F32 {
    return lowlevel { ffi_euclidean_distance_f32(a, b, dim) }
}

/// Computes the squared L2 distance between two F32 vectors.
///
/// Avoids the sqrt operation for faster comparison. Use when
/// only relative ordering matters (not absolute distance).
///
/// @param a First vector
/// @param b Second vector
/// @param dim Number of dimensions
/// @returns Squared L2 distance (always >= 0)
pub func l2_squared_f32(a: *F32, b: *F32, dim: I64) -> F32 {
    return lowlevel { ffi_l2_squared_f32(a, b, dim) }
}

/// Computes the L2 norm (magnitude) of an F32 vector.
///
/// @param v Input vector
/// @param dim Number of dimensions
/// @returns L2 norm (always >= 0)
pub func norm_f32(v: *F32, dim: I64) -> F32 {
    return lowlevel { ffi_norm_f32(v, dim) }
}

/// Normalizes an F32 vector in place (makes it unit length).
///
/// After normalization, the vector has L2 norm of 1.0.
/// If the vector has zero magnitude, it is left unchanged.
///
/// @param v Vector to normalize (modified in place)
/// @param dim Number of dimensions
pub func normalize_f32(v: *F32, dim: I64) -> Unit {
    lowlevel { ffi_normalize_f32(v, dim) }
}
