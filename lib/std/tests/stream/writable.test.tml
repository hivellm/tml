// Tests for std::stream ByteStream writing.
use test::{assert, assert_eq}
use std::stream::byte_stream::{ByteStream, write_string}

@test
func test_bytestream_write_string_helper() -> I32 {
    var stream: ByteStream = ByteStream::new()
    let result = write_string(mut ref stream, "hello")
    when result {
        Err(e) => return 1,
        Ok(n) => assert_eq(n, 5 as I64, "wrote 5"),
    }
    assert_eq(stream.len(), 5 as I64, "len 5")
    let s: Str = stream.to_string()
    assert_eq(s, "hello", "to_string")
    stream.destroy()
    return 0
}

@test
func test_bytestream_clear() -> I32 {
    var stream: ByteStream = ByteStream::from_string("data")
    assert_eq(stream.len(), 4 as I64, "len before clear")
    stream.clear()
    assert_eq(stream.len(), 0 as I64, "len after clear")
    assert(stream.is_empty(), "empty after clear")
    stream.destroy()
    return 0
}

@test
func test_bytestream_write_then_read() -> I32 {
    var stream: ByteStream = ByteStream::new()
    let r = write_string(mut ref stream, "test")
    when r {
        Err(e) => return 1,
        Ok(n) => assert_eq(n, 4 as I64, "wrote 4"),
    }
    assert_eq(stream.remaining(), 4 as I64, "4 remaining")

    var buf: [U8; 4] = [0 as U8; 4]
    let r2 = stream.read(mut ref buf)
    when r2 {
        Err(e) => return 1,
        Ok(n) => {
            assert_eq(n, 4 as I64, "read 4")
            assert_eq(buf[0] as I64, 116 as I64, "t")
            assert_eq(buf[3] as I64, 116 as I64, "t")
        },
    }
    assert(stream.is_eof(), "eof")
    stream.destroy()
    return 0
}

@test
func test_bytestream_with_capacity() -> I32 {
    var stream: ByteStream = ByteStream::with_capacity(8)
    assert(stream.is_empty(), "empty")
    let r = write_string(mut ref stream, "hello world this is a long string")
    when r {
        Err(e) => return 1,
        Ok(n) => assert_eq(n, 33 as I64, "wrote 33"),
    }
    assert_eq(stream.len(), 33 as I64, "len 33")
    stream.destroy()
    return 0
}
