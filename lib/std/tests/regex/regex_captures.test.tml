// Tests for std::regex::Regex captures()
use test::{assert, assert_eq}
use std::regex::{Regex, Captures}

@test
func test_captures_basic() -> I32 {
    let re: Regex = Regex::new("(\\d+)-(\\d+)")
    let cap: Captures = re.captures("foo 123-456 bar")
    assert(cap.matched(), "should match")
    assert_eq(cap.num_groups(), 3, "3 groups: full + 2 captures")
    let g0: Str = cap.get(0, "foo 123-456 bar")
    assert_eq(g0, "123-456", "group 0 should be full match")
    let g1: Str = cap.get(1, "foo 123-456 bar")
    assert_eq(g1, "123", "group 1 should be first digits")
    let g2: Str = cap.get(2, "foo 123-456 bar")
    assert_eq(g2, "456", "group 2 should be second digits")
    return 0
}

@test
func test_captures_no_match() -> I32 {
    let re: Regex = Regex::new("(xyz)")
    let cap: Captures = re.captures("hello world")
    assert(not cap.matched(), "should not match")
    assert_eq(cap.start(0), -1, "unmatched group start should be -1")
    assert_eq(cap.end(0), -1, "unmatched group end should be -1")
    let g: Str = cap.get(0, "hello world")
    assert_eq(g, "", "unmatched get should return empty")
    return 0
}

@test
func test_captures_single_group() -> I32 {
    let re: Regex = Regex::new("hello (\\w+)")
    let cap: Captures = re.captures("say hello world!")
    assert(cap.matched(), "should match")
    let g0: Str = cap.get(0, "say hello world!")
    assert_eq(g0, "hello world", "group 0 full match")
    let g1: Str = cap.get(1, "say hello world!")
    assert_eq(g1, "world", "group 1 should be word after hello")
    return 0
}

@test
func test_captures_alternation() -> I32 {
    let re: Regex = Regex::new("(cat|dog)")
    let cap: Captures = re.captures("my dog")
    assert(cap.matched(), "should match")
    let g1: Str = cap.get(1, "my dog")
    assert_eq(g1, "dog", "group 1 = dog")
    return 0
}

@test
func test_captures_positions() -> I32 {
    let re: Regex = Regex::new("(\\d+)")
    let cap: Captures = re.captures("abc 42 def")
    assert(cap.matched(), "should match")
    assert_eq(cap.start(0), 4, "full match starts at 4")
    assert_eq(cap.end(0), 6, "full match ends at 6")
    assert_eq(cap.start(1), 4, "group 1 starts at 4")
    assert_eq(cap.end(1), 6, "group 1 ends at 6")
    return 0
}

@test
func test_captures_no_groups() -> I32 {
    let re: Regex = Regex::new("\\d+")
    let cap: Captures = re.captures("abc 42 def")
    assert(cap.matched(), "should match")
    assert_eq(cap.num_groups(), 1, "only group 0 for no-group regex")
    let g0: Str = cap.get(0, "abc 42 def")
    assert_eq(g0, "42", "group 0 full match")
    return 0
}

@test
func test_captures_out_of_bounds() -> I32 {
    let re: Regex = Regex::new("(a)")
    let cap: Captures = re.captures("a")
    assert(cap.matched(), "should match")
    // Out of bounds group
    assert_eq(cap.start(-1), -1, "negative group returns -1")
    assert_eq(cap.start(99), -1, "large group returns -1")
    let g: Str = cap.get(99, "a")
    assert_eq(g, "", "out of bounds get returns empty")
    return 0
}

@test
func test_captures_multiple_groups() -> I32 {
    let re: Regex = Regex::new("(\\w+)@(\\w+)\\.(\\w+)")
    let cap: Captures = re.captures("email: user@host.com ok")
    assert(cap.matched(), "should match email-like pattern")
    assert_eq(cap.num_groups(), 4, "4 groups: full + 3")
    let g0: Str = cap.get(0, "email: user@host.com ok")
    assert_eq(g0, "user@host.com", "full match")
    let g1: Str = cap.get(1, "email: user@host.com ok")
    assert_eq(g1, "user", "group 1 = user")
    let g2: Str = cap.get(2, "email: user@host.com ok")
    assert_eq(g2, "host", "group 2 = host")
    let g3: Str = cap.get(3, "email: user@host.com ok")
    assert_eq(g3, "com", "group 3 = com")
    return 0
}
