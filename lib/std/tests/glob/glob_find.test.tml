//! Tests for glob filesystem matching.

use std::glob::{Glob, matches}
use std::file::{File, Dir, Path}
use test::{assert, assert_eq}

@test
func test_glob_find_tml_files() -> I32 {
    Dir::create_all("_gt1/src")
    File::write_all("_gt1/src/a.tml", "a")
    File::write_all("_gt1/src/b.tml", "b")
    File::write_all("_gt1/src/c.rs", "c")

    var g: Glob = Glob::find("_gt1/src", "*.tml")
    let n: I64 = g.count()
    g.free()

    // cleanup
    Path::remove("_gt1/src/a.tml")
    Path::remove("_gt1/src/b.tml")
    Path::remove("_gt1/src/c.rs")
    Dir::remove("_gt1/src")
    Dir::remove("_gt1")

    assert_eq(n, 2, "should find 2 .tml files")
    return 0
}

@test
func test_glob_find_no_matches() -> I32 {
    Dir::create_all("_gt2")
    File::write_all("_gt2/hello.txt", "hi")

    var g: Glob = Glob::find("_gt2", "*.xyz")
    let n: I64 = g.count()
    g.free()

    Path::remove("_gt2/hello.txt")
    Dir::remove("_gt2")

    assert_eq(n, 0, "should find 0 .xyz files")
    return 0
}

@test
func test_glob_recursive_tml() -> I32 {
    Dir::create_all("_gt3/a/b")
    File::write_all("_gt3/x.tml", "x")
    File::write_all("_gt3/a/y.tml", "y")
    File::write_all("_gt3/a/b/z.tml", "z")

    var g: Glob = Glob::find("_gt3", "**/*.tml")
    let n: I64 = g.count()
    g.free()

    Path::remove("_gt3/x.tml")
    Path::remove("_gt3/a/y.tml")
    Path::remove("_gt3/a/b/z.tml")
    Dir::remove("_gt3/a/b")
    Dir::remove("_gt3/a")
    Dir::remove("_gt3")

    assert_eq(n, 3, "should find 3 .tml files recursively")
    return 0
}

@test
func test_glob_subdirectory_pattern() -> I32 {
    Dir::create_all("_gt4/src")
    Dir::create_all("_gt4/lib")
    File::write_all("_gt4/src/a.tml", "a")
    File::write_all("_gt4/lib/b.tml", "b")
    File::write_all("_gt4/readme.txt", "hi")

    var g: Glob = Glob::find("_gt4", "src/*.tml")
    let n: I64 = g.count()
    g.free()

    Path::remove("_gt4/src/a.tml")
    Path::remove("_gt4/lib/b.tml")
    Path::remove("_gt4/readme.txt")
    Dir::remove("_gt4/src")
    Dir::remove("_gt4/lib")
    Dir::remove("_gt4")

    assert_eq(n, 1, "should find 1 .tml file in src/ only")
    return 0
}
