// Tests for HashMap[K, V] collection type
use test
use std::collections::{HashMap, HashMapIter}

// ============================================================================
// HashMap Basic Operations
// ============================================================================

@test
func test_hashmap_new() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)
    assert_eq(map.len(), 0 as I64, "new hashmap should have len 0")
    map.destroy()
    return 0
}

@test
func test_hashmap_default() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].default()
    assert_eq(map.len(), 0 as I64, "default hashmap should have len 0")
    map.destroy()
    return 0
}

@test
func test_hashmap_set_and_get() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(1, 100)
    map.set(2, 85)
    map.set(3, 90)

    assert_eq(map.len(), 3 as I64, "len after 3 sets")

    let v1: I32 = map.get(1)
    assert_eq(v1, 100, "get key 1")

    let v2: I32 = map.get(2)
    assert_eq(v2, 85, "get key 2")

    let v3: I32 = map.get(3)
    assert_eq(v3, 90, "get key 3")

    map.destroy()
    return 0
}

@test
func test_hashmap_has() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(1, 10)
    map.set(2, 20)

    assert(map.has(1), "has key 1")
    assert(map.has(2), "has key 2")
    assert(not map.has(3), "does not have key 3")

    map.destroy()
    return 0
}

@test
func test_hashmap_remove() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(1, 10)
    map.set(2, 20)
    map.set(3, 30)

    assert_eq(map.len(), 3 as I64, "len before remove")

    let removed: Bool = map.remove(2)
    assert(removed, "remove should return true for existing key")
    assert_eq(map.len(), 2 as I64, "len after remove")
    assert(not map.has(2), "key 2 should be gone")

    let not_found: Bool = map.remove(999)
    assert(not not_found, "remove should return false for missing key")

    map.destroy()
    return 0
}

@test
func test_hashmap_clear() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(1, 100)
    map.set(2, 200)
    map.set(3, 300)

    assert_eq(map.len(), 3 as I64, "len before clear")

    map.clear()

    assert_eq(map.len(), 0 as I64, "len after clear")
    assert(not map.has(1), "key 1 should be gone after clear")

    map.destroy()
    return 0
}

@test
func test_hashmap_update_value() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(100, 50)
    assert_eq(map.get(100), 50, "initial value")

    map.set(100, 999)
    assert_eq(map.get(100), 999, "updated value")
    assert_eq(map.len(), 1 as I64, "len should still be 1")

    map.destroy()
    return 0
}

@test
func test_hashmap_i64_keys() -> I32 {
    let map: HashMap[I64, I64] = HashMap[I64, I64].new(16)

    map.set(1000000000000 as I64, 999 as I64)
    map.set(1 as I64, 111 as I64)

    assert_eq(map.get(1000000000000 as I64), 999 as I64, "get large key")
    assert_eq(map.get(1 as I64), 111 as I64, "get small key")

    map.destroy()
    return 0
}

// ============================================================================
// HashMap Iterator
// ============================================================================

@test
func test_hashmap_iter() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    map.set(1, 10)
    map.set(2, 20)
    map.set(3, 30)

    var sum: I32 = 0
    var count: I32 = 0

    let iter: HashMapIter[I32, I32] = map.iter()
    loop (iter.has_next()) {
        let k: I32 = iter.key()
        let v: I32 = iter.value()
        sum = sum + v
        count = count + 1
        iter.next()
    }
    iter.destroy()

    assert_eq(count, 3, "should iterate 3 times")
    assert_eq(sum, 60, "sum of values")

    map.destroy()
    return 0
}

@test
func test_hashmap_iter_empty() -> I32 {
    let map: HashMap[I32, I32] = HashMap[I32, I32].new(16)

    let iter: HashMapIter[I32, I32] = map.iter()
    assert(not iter.has_next(), "empty map iter should have no next")
    iter.destroy()

    map.destroy()
    return 0
}

// ============================================================================
// HashMap with String Keys (tests codegen fix for ptr type keys)
// ============================================================================

@test
func test_hashmap_str_keys() -> I32 {
    let map: HashMap[Str, I32] = HashMap[Str, I32].new(16)

    map.set("alice", 100)
    map.set("bob", 85)
    map.set("charlie", 90)

    assert_eq(map.len(), 3 as I64, "len after 3 sets")

    let alice: I32 = map.get("alice")
    assert_eq(alice, 100, "get alice score")

    let bob: I32 = map.get("bob")
    assert_eq(bob, 85, "get bob score")

    map.destroy()
    return 0
}

@test
func test_hashmap_str_has() -> I32 {
    let map: HashMap[Str, I32] = HashMap[Str, I32].new(16)

    map.set("key1", 1)
    map.set("key2", 2)

    assert(map.has("key1"), "has key1")
    assert(map.has("key2"), "has key2")
    assert(not map.has("key3"), "does not have key3")

    map.destroy()
    return 0
}

@test
func test_hashmap_str_remove() -> I32 {
    let map: HashMap[Str, I32] = HashMap[Str, I32].new(16)

    map.set("a", 1)
    map.set("b", 2)

    let removed: Bool = map.remove("a")
    assert(removed, "remove should return true")
    assert(not map.has("a"), "a should be gone")

    map.destroy()
    return 0
}


