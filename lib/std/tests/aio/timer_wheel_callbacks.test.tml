use std::aio::timer_wheel::TimerWheel
use test::*

/// Dummy callback for testing
func dummy_callback(user_data: I64) {
    // This callback is invoked by the timer wheel when the timer fires.
    // The fact that this code is reached (without crash) proves the fix works.
}

@test
func test_schedule_and_fire_basic_timer() {
    let wheel: TimerWheel = TimerWheel::new(0)

    // Schedule a timer that should fire after 10ms
    let cb: I64 = dummy_callback as I64
    let timer_id = wheel.schedule(10, cb, 0)
    assert(timer_id.is_valid(), "schedule should return valid timer_id")
    assert_eq(wheel.active_count, 1, "active_count should be 1 after schedule")

    // Advance by 20ms — timer should fire
    let fired: I64 = wheel.advance(20)
    assert_eq(fired, 1, "advance should report 1 fired timer")
    // Note: active_count is decremented inside fire_slot_level0 when callback is invoked
    assert_eq(wheel.active_count, 0, "active_count should be 0 after timer fires")

    wheel.destroy()
}

@test
func test_overflow_timer_fires() {
    let wheel: TimerWheel = TimerWheel::new(0)

    // Schedule a timer for 5000ms (beyond 4-second level-0 window)
    let cb: I64 = dummy_callback as I64
    let timer_id = wheel.schedule(5000, cb, 0)
    assert(timer_id.is_valid(), "schedule should return valid timer_id")
    assert_eq(wheel.active_count, 1, "wheel should have active timer")

    // Advance by 6000ms — timer should fire from overflow
    let fired: I64 = wheel.advance(6000)
    assert_eq(fired, 1, "advance should report 1 fired timer from overflow")
    assert_eq(wheel.active_count, 0, "active_count should be 0 after overflow timer fires")

    wheel.destroy()
}

@test
func test_multiple_timers_fire_in_order() {
    let wheel: TimerWheel = TimerWheel::new(0)

    // Schedule three timers at different times
    let cb: I64 = dummy_callback as I64
    let timer1 = wheel.schedule(10, cb, 0)
    let timer2 = wheel.schedule(20, cb, 0)
    let timer3 = wheel.schedule(30, cb, 0)

    assert_eq(wheel.active_count, 3, "should have 3 active timers")

    // Advance by 35ms — all three should fire
    let fired: I64 = wheel.advance(35)
    assert_eq(fired, 3, "advance should report 3 fired timers")
    assert_eq(wheel.active_count, 0, "all timers should be inactive after firing")

    wheel.destroy()
}
