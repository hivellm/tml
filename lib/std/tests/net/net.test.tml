//! Network Standard Library Tests
//!
//! Tests for socket addresses, raw sockets, and error types.
//! IP address tests are in ip.test.tml.

use test::{assert, assert_eq}
use std::net::{SocketAddr, SocketAddrV4, Ipv4Addr, Ipv6Addr, IpAddr}
use std::net::sys::{RawSocket}
use std::net::error::{NetError, NetErrorKind}

// ============================================================================
// Socket Address Tests
// ============================================================================

@test
func test_socket_addr_v4_creation() {
    let ip: Ipv4Addr = Ipv4Addr::LOCALHOST()
    let addr: SocketAddrV4 = SocketAddrV4::new(ip, 8080 as U16)

    assert_eq(addr.port(), 8080 as U16)
    assert(addr.ip().is_loopback(), "IP should be loopback")
}

@test
func test_socket_addr_port_change() {
    let ip: Ipv4Addr = Ipv4Addr::LOCALHOST()
    var addr: SocketAddrV4 = SocketAddrV4::new(ip, 8080 as U16)

    assert_eq(addr.port(), 8080 as U16)

    addr.set_port(9090 as U16)
    assert_eq(addr.port(), 9090 as U16)
}

@test
func test_socket_addr_enum() {
    let v4: SocketAddrV4 = SocketAddrV4::new(Ipv4Addr::LOCALHOST(), 80 as U16)
    let addr: SocketAddr = SocketAddr::V4(v4)

    assert(addr.is_ipv4(), "Should be IPv4")
    assert(not addr.is_ipv6(), "Should not be IPv6")
    assert_eq(addr.port(), 80 as U16)
}

@test
func test_socket_addr_v4_set_ip() {
    let ip1: Ipv4Addr = Ipv4Addr::LOCALHOST()
    var addr: SocketAddrV4 = SocketAddrV4::new(ip1, 8080 as U16)
    assert(addr.ip().is_loopback(), "initial IP should be loopback")

    let ip2: Ipv4Addr = Ipv4Addr::new(192, 168, 1, 1)
    addr.set_ip(ip2)
    assert(addr.ip().is_private(), "updated IP should be private")
    assert_eq(addr.port(), 8080 as U16, "port should not change")
}

@test
func test_socket_addr_ip() {
    let v4: SocketAddrV4 = SocketAddrV4::new(Ipv4Addr::LOCALHOST(), 443 as U16)
    let addr: SocketAddr = SocketAddr::V4(v4)
    let ip: IpAddr = addr.ip()
    assert(ip.is_ipv4(), "ip() should return IPv4")
    assert(ip.is_loopback(), "ip() should be loopback")
}

@test
func test_socket_addr_set_port() {
    let v4: SocketAddrV4 = SocketAddrV4::new(Ipv4Addr::LOCALHOST(), 80 as U16)
    var addr: SocketAddr = SocketAddr::V4(v4)
    assert_eq(addr.port(), 80 as U16, "initial port")

    addr.set_port(443 as U16)
    assert_eq(addr.port(), 443 as U16, "updated port")
}

// ============================================================================
// RawSocket Tests
// ============================================================================

@test
func test_raw_socket_tcp_creation() {
    let result: Outcome[RawSocket, NetError] = RawSocket::tcp()
    when result {
        Ok(sock) => {
            assert(sock.is_valid(), "TCP socket should be valid")
        },
        Err(_) => {
            // Socket creation may fail on some systems (e.g., sandboxed environments)
        },
    }
}

@test
func test_raw_socket_udp_creation() {
    let result: Outcome[RawSocket, NetError] = RawSocket::udp()
    when result {
        Ok(sock) => {
            assert(sock.is_valid(), "UDP socket should be valid")
        },
        Err(_) => {
            // Socket creation may fail on some systems
        },
    }
}

// ============================================================================
// Error Type Tests
// ============================================================================

@test
func test_net_error_kinds() {
    let conn_refused: NetError = NetError::new(NetErrorKind::ConnectionRefused())
    assert(conn_refused.is_connection_refused(), "Should be connection refused")

    let would_block: NetError = NetError::new(NetErrorKind::WouldBlock())
    assert(would_block.is_would_block(), "Should be would block")

    let not_connected: NetError = NetError::new(NetErrorKind::NotConnected())
    assert(not_connected.is_not_connected(), "Should be not connected")
}
