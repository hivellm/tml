// TLS certificate verification tests.
// Validates that SSL_VERIFY_PEER mode works with the Windows certificate store.
// This proves certificates from real CAs are properly validated.
use test::{assert, assert_eq}
use std::net::dns
use std::net::ip::Ipv4Addr
use std::net::{SocketAddr, SocketAddrV4}
use std::net::tcp::TcpStream
use std::net::tls::{TlsContext, TlsStream, TlsVerifyMode}
use std::net::tls
use std::net::sys::RawSocket

// ============================================================================
// Certificate verification with Peer() mode against google.com
// ============================================================================

@test
func test_tls_cert_verify_google() -> I32 {
    let ip: Ipv4Addr = dns::lookup("google.com").unwrap()
    let addr: SocketAddr = SocketAddr::V4(SocketAddrV4::new(ip, 443 as U16))
    let tcp: TcpStream = TcpStream::connect(addr).unwrap()

    // Use Peer() mode â€” actual certificate validation via Windows cert store
    let ctx: TlsContext = TlsContext::client().unwrap()
    ctx.set_verify_mode(TlsVerifyMode::Peer())

    let raw: RawSocket = tcp.into_raw_socket()
    let fd: I64 = raw.handle
    let stream: TlsStream = TlsStream::connect(ctx, fd, "google.com").unwrap()

    // verify_result should be 0 (X509_V_OK) with real CA validation
    let verify_code: I32 = stream.verify_result()
    assert_eq(verify_code, 0, "verify_result should be 0 (X509_V_OK)")
    print("  [cert verify] verify_result: 0 (X509_V_OK)\n")

    // peer_verified should be true
    let verified: Bool = stream.peer_verified()
    assert(verified, "peer should be verified with Peer() mode")
    print("  [cert verify] peer_verified: true\n")

    // CN should be present
    let cn: Str = stream.peer_cn()
    print("  [cert verify] peer CN: " + cn + "\n")
    assert(cn.len() > 0, "peer CN should not be empty")

    // PEM should be valid
    let pem: Str = stream.peer_cert_pem()
    assert(pem.len() > 100, "cert PEM should be substantial")
    assert(pem.contains("BEGIN CERTIFICATE"), "PEM should contain BEGIN CERTIFICATE")
    print("  [cert verify] cert PEM: valid\n")

    stream.shutdown()
    0
}
