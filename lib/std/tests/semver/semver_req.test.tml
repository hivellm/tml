use test
use std::semver::Version
use std::semver::VersionReq

@test
func test_req_parse_caret() -> I32 {
    let result = VersionReq::parse("^1.2.3")
    when result {
        Ok(req) => {
            assert_eq(req.op, 5)
            assert_eq(req.version.major, 1 as I64)
            assert_eq(req.version.minor, 2 as I64)
            assert_eq(req.version.patch, 3 as I64)
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_parse_tilde() -> I32 {
    let result = VersionReq::parse("~1.2.0")
    when result {
        Ok(req) => {
            assert_eq(req.op, 6)
            assert_eq(req.version.major, 1 as I64)
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_parse_exact() -> I32 {
    let result = VersionReq::parse("=1.0.0")
    when result {
        Ok(req) => {
            assert_eq(req.op, 0)
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_parse_gte() -> I32 {
    let result = VersionReq::parse(">=2.0.0")
    when result {
        Ok(req) => {
            assert_eq(req.op, 2)
            assert_eq(req.version.major, 2 as I64)
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_caret_matches() -> I32 {
    let result = VersionReq::parse("^1.2.3")
    when result {
        Ok(req) => {
            // ^1.2.3 matches >=1.2.3, <2.0.0
            assert(req.matches(Version::new(1, 2, 3)), "exact match")
            assert(req.matches(Version::new(1, 9, 0)), "higher minor")
            assert(not req.matches(Version::new(2, 0, 0)), "next major")
            assert(not req.matches(Version::new(1, 2, 2)), "lower patch")
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_tilde_matches() -> I32 {
    let result = VersionReq::parse("~1.2.0")
    when result {
        Ok(req) => {
            // ~1.2.0 matches >=1.2.0, <1.3.0
            assert(req.matches(Version::new(1, 2, 0)), "exact match")
            assert(req.matches(Version::new(1, 2, 5)), "higher patch")
            assert(not req.matches(Version::new(1, 3, 0)), "next minor")
            assert(not req.matches(Version::new(2, 0, 0)), "next major")
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_exact_matches() -> I32 {
    let result = VersionReq::parse("=1.0.0")
    when result {
        Ok(req) => {
            assert(req.matches(Version::new(1, 0, 0)), "exact")
            assert(not req.matches(Version::new(1, 0, 1)), "different patch")
            assert(not req.matches(Version::new(1, 1, 0)), "different minor")
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}

@test
func test_req_gt_matches() -> I32 {
    let result = VersionReq::parse(">1.0.0")
    when result {
        Ok(req) => {
            assert(req.matches(Version::new(1, 0, 1)), "higher patch")
            assert(req.matches(Version::new(2, 0, 0)), "higher major")
            assert(not req.matches(Version::new(1, 0, 0)), "equal")
            assert(not req.matches(Version::new(0, 9, 0)), "lower")
        }
        Err(e) => assert(false, "parse should succeed")
    }
    0
}
