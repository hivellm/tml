//! Tests for crypto X.509 certificate functions
//!
//! Tests certificate parsing, validation, and chain verification.

use std::crypto::{X509Certificate, X509Chain, X509Store, X509Name, KeyUsage}
use std::crypto::{generate_key_pair, KeyType}
use std::collections::Buffer
use test::{assert, assert_eq}

// ============================================================================
// X509Certificate Parsing Tests
// ============================================================================

@test
func test_x509_parse_pem() -> I32 {
    // A simple self-signed test certificate (PEM format)
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            // Certificate should parse successfully
            assert(c.subject().contains("testca"))
            c.destroy()
        }
        Nothing => {
            // Parsing might fail if the cert is malformed or not supported
        }
    }

    return 0
}

@test
func test_x509_parse_der() -> I32 {
    // DER-encoded certificate (base64 decoded from PEM)
    let der_base64 = "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRlc3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMMBnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJHkXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6bAgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa"

    let der = Buffer.from_base64(der_base64)

    when der {
        Just(d) => {
            let cert = X509Certificate.from_der(d)

            when cert {
                Just(c) => {
                    assert(c.subject().contains("testca"))
                    c.destroy()
                }
                Nothing => {}
            }

            d.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Certificate Properties Tests
// ============================================================================

@test
func test_x509_subject_issuer() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            // For self-signed, subject == issuer
            let subject = c.subject()
            let issuer = c.issuer()

            assert_eq(subject, issuer)

            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_serial_number() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let serial = c.serial_number()
            assert(serial.len() > 0)
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_validity_dates() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let not_before = c.not_before()
            let not_after = c.not_after()

            // Dates should be valid timestamps
            assert(not_before > 0)
            assert(not_after > not_before)

            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_is_valid_now() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            // This cert is valid from 2020 to 2030
            assert(c.is_valid_now())
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Certificate Key Usage Tests
// ============================================================================

@test
func test_x509_key_usage() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let usage = c.key_usage()

            when usage {
                Just(u) => {
                    // Check various key usage flags
                    // (actual values depend on the certificate)
                }
                Nothing => {
                    // No key usage extension in this simple cert
                }
            }

            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_is_ca() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            // Simple self-signed cert without basic constraints is not a CA
            // (actual behavior depends on implementation)
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Certificate Public Key Tests
// ============================================================================

@test
func test_x509_public_key() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let pub_key = c.public_key()

            when pub_key {
                Just(pk) => {
                    assert(pk.len() > 0)
                    pk.destroy()
                }
                Nothing => {}
            }

            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509 Fingerprint Tests
// ============================================================================

@test
func test_x509_fingerprint_sha256() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let fingerprint = c.fingerprint_sha256()
            // SHA-256 fingerprint is 32 bytes
            assert_eq(fingerprint.len(), 32)

            fingerprint.destroy()
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_fingerprint_sha1() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let fingerprint = c.fingerprint_sha1()
            // SHA-1 fingerprint is 20 bytes
            assert_eq(fingerprint.len(), 20)

            fingerprint.destroy()
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Chain Tests
// ============================================================================

@test
func test_x509_chain_build() -> I32 {
    // Build a chain from a single self-signed certificate
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let chain = X509Chain.new()
            chain.add(c)

            assert_eq(chain.len(), 1)

            chain.destroy()
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Store Tests
// ============================================================================

@test
func test_x509_store_create() -> I32 {
    let store = X509Store.new()

    // Empty store should exist
    assert_eq(store.len(), 0)

    store.destroy()
    return 0
}

@test
func test_x509_store_add_cert() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let store = X509Store.new()
            store.add_cert(c)

            assert_eq(store.len(), 1)

            store.destroy()
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

// ============================================================================
// X509Name Tests
// ============================================================================

@test
func test_x509_name_parse() -> I32 {
    let name = X509Name.parse("CN=example.com,O=Example Inc,C=US")

    when name {
        Just(n) => {
            assert_eq(n.common_name(), "example.com")
            assert_eq(n.organization(), "Example Inc")
            assert_eq(n.country(), "US")

            n.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_name_to_string() -> I32 {
    let name = X509Name.new()
    name.set_common_name("test.example.com")
    name.set_organization("Test Org")
    name.set_country("US")

    let str = name.to_string()
    assert(str.contains("test.example.com"))
    assert(str.contains("Test Org"))

    name.destroy()
    return 0
}

// ============================================================================
// Certificate Export Tests
// ============================================================================

@test
func test_x509_export_pem() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let exported = c.export_pem()
            assert(exported.starts_with("-----BEGIN CERTIFICATE-----"))
            assert(exported.ends_with("-----END CERTIFICATE-----\n"))

            c.destroy()
        }
        Nothing => {}
    }

    return 0
}

@test
func test_x509_export_der() -> I32 {
    let pem = "-----BEGIN CERTIFICATE-----\n" +
        "MIIBkjCB/AIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBnRl\n" +
        "c3RjYTAeFw0yMDAxMDEwMDAwMDBaFw0zMDAxMDEwMDAwMDBaMBExDzANBgNVBAMM\n" +
        "BnRlc3RjYTBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQC6D7a9sQI7xe6J1+1D9xJH\n" +
        "kXV6FMWJqL8pB8pBz7GvS3e8SqWxJmWCqJN6V+N8r/D8V6i8RQ6P7e5u+P4FBk6b\n" +
        "AgMBAAEwDQYJKoZIhvcNAQELBQADQQBGZ1F6kXrlQjP3Y7tYGGqxMJkP4N5pL5cL\n" +
        "6e6L1Wk7cPbRnLqN5xJL7K+l2wt2RFKv+6g8O7NxLnPbFMPuNqYa\n" +
        "-----END CERTIFICATE-----"

    let cert = X509Certificate.from_pem(pem)

    when cert {
        Just(c) => {
            let der = c.export_der()
            assert(der.len() > 0)

            // Re-parse the DER
            let reparsed = X509Certificate.from_der(der)
            when reparsed {
                Just(c2) => {
                    assert_eq(c.subject(), c2.subject())
                    c2.destroy()
                }
                Nothing => {}
            }

            der.destroy()
            c.destroy()
        }
        Nothing => {}
    }

    return 0
}
