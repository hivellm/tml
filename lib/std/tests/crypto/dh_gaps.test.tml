// Tests for crypto/dh enum methods and DH key exchange operations
use test::{assert, assert_eq}
use std::crypto::dh::{DhGroup, DiffieHellman, get_dh_group_params}
use std::collections::Buffer

// --- DhGroup::name ---

@test
func test_dh_group_name() -> I32 {
    assert_eq(DhGroup::Modp1.name(), "modp1", "Modp1 name")
    assert_eq(DhGroup::Modp2.name(), "modp2", "Modp2 name")
    assert_eq(DhGroup::Modp5.name(), "modp5", "Modp5 name")
    assert_eq(DhGroup::Modp14.name(), "modp14", "Modp14 name")
    assert_eq(DhGroup::Modp15.name(), "modp15", "Modp15 name")
    assert_eq(DhGroup::Modp16.name(), "modp16", "Modp16 name")
    assert_eq(DhGroup::Modp17.name(), "modp17", "Modp17 name")
    assert_eq(DhGroup::Modp18.name(), "modp18", "Modp18 name")
    assert_eq(DhGroup::Ffdhe2048.name(), "ffdhe2048", "Ffdhe2048 name")
    assert_eq(DhGroup::Ffdhe3072.name(), "ffdhe3072", "Ffdhe3072 name")
    assert_eq(DhGroup::Ffdhe4096.name(), "ffdhe4096", "Ffdhe4096 name")
    assert_eq(DhGroup::Ffdhe6144.name(), "ffdhe6144", "Ffdhe6144 name")
    assert_eq(DhGroup::Ffdhe8192.name(), "ffdhe8192", "Ffdhe8192 name")
    return 0
}

// --- DhGroup::prime_bits ---

@test
func test_dh_group_prime_bits() -> I32 {
    assert_eq(DhGroup::Modp1.prime_bits(), 768 as I64, "Modp1 bits")
    assert_eq(DhGroup::Modp2.prime_bits(), 1024 as I64, "Modp2 bits")
    assert_eq(DhGroup::Modp5.prime_bits(), 1536 as I64, "Modp5 bits")
    assert_eq(DhGroup::Modp14.prime_bits(), 2048 as I64, "Modp14 bits")
    assert_eq(DhGroup::Modp15.prime_bits(), 3072 as I64, "Modp15 bits")
    assert_eq(DhGroup::Modp16.prime_bits(), 4096 as I64, "Modp16 bits")
    assert_eq(DhGroup::Modp17.prime_bits(), 6144 as I64, "Modp17 bits")
    assert_eq(DhGroup::Modp18.prime_bits(), 8192 as I64, "Modp18 bits")
    assert_eq(DhGroup::Ffdhe2048.prime_bits(), 2048 as I64, "Ffdhe2048 bits")
    assert_eq(DhGroup::Ffdhe3072.prime_bits(), 3072 as I64, "Ffdhe3072 bits")
    assert_eq(DhGroup::Ffdhe4096.prime_bits(), 4096 as I64, "Ffdhe4096 bits")
    assert_eq(DhGroup::Ffdhe6144.prime_bits(), 6144 as I64, "Ffdhe6144 bits")
    assert_eq(DhGroup::Ffdhe8192.prime_bits(), 8192 as I64, "Ffdhe8192 bits")
    return 0
}

// --- DhGroup::is_deprecated ---

@test
func test_dh_group_is_deprecated() -> I32 {
    assert(DhGroup::Modp1.is_deprecated(), "Modp1 deprecated")
    assert(DhGroup::Modp2.is_deprecated(), "Modp2 deprecated")
    assert(DhGroup::Modp5.is_deprecated(), "Modp5 deprecated")
    assert(not DhGroup::Modp14.is_deprecated(), "Modp14 not deprecated")
    assert(not DhGroup::Modp15.is_deprecated(), "Modp15 not deprecated")
    assert(not DhGroup::Ffdhe2048.is_deprecated(), "Ffdhe2048 not deprecated")
    return 0
}

// --- DhGroup::from_name ---

@test
func test_dh_group_from_name_valid() -> I32 {
    let m14: Maybe[DhGroup] = DhGroup::from_name("modp14")
    assert(m14.is_just(), "modp14 found")
    let ff: Maybe[DhGroup] = DhGroup::from_name("ffdhe2048")
    assert(ff.is_just(), "ffdhe2048 found")
    return 0
}

@test
func test_dh_group_from_name_invalid() -> I32 {
    let result: Maybe[DhGroup] = DhGroup::from_name("invalid")
    assert(result.is_nothing(), "invalid group is Nothing")
    return 0
}

// --- DH key exchange operations ---
// Using modp2 (1024-bit) for speed in tests (insecure but fast)

@test
func test_dh_with_group_create() -> I32 {
    let result = DiffieHellman::with_group(DhGroup::Modp2)
    when result {
        Ok(dh) => {
            assert_eq(dh.prime_length(), 1024 as I64, "modp2 prime length")
            assert(dh.check_params(), "modp2 params valid")
        }
        Err(_e) => { assert(false, "DH with_group failed") }
    }
    return 0
}

@test
func test_dh_generate_keys() -> I32 {
    let result = DiffieHellman::with_group(DhGroup::Modp2)
    when result {
        Ok(mut dh) => {
            dh.generate_keys()
            let pub_key: Buffer = dh.public_key()
            assert(pub_key.len() > (0 as I64), "public key not empty")
            let priv_key: Buffer = dh.private_key()
            assert(priv_key.len() > (0 as I64), "private key not empty")
        }
        Err(_e) => { assert(false, "DH gen failed") }
    }
    return 0
}

@test
func test_dh_key_exchange() -> I32 {
    let alice_r = DiffieHellman::with_group(DhGroup::Modp2)
    let bob_r = DiffieHellman::with_group(DhGroup::Modp2)
    when alice_r {
        Ok(mut alice) => {
            alice.generate_keys()
            let alice_pub: Buffer = alice.public_key()
            when bob_r {
                Ok(mut bob) => {
                    bob.generate_keys()
                    let bob_pub: Buffer = bob.public_key()
                    let as_r = alice.compute_secret(ref bob_pub)
                    let bs_r = bob.compute_secret(ref alice_pub)
                    when as_r {
                        Ok(as_) => {
                            when bs_r {
                                Ok(bs) => {
                                    assert_eq(as_.len(), bs.len(), "shared secrets same length")
                                }
                                Err(_) => { assert(false, "bob compute failed") }
                            }
                        }
                        Err(_) => { assert(false, "alice compute failed") }
                    }
                }
                Err(_) => { assert(false, "bob DH failed") }
            }
        }
        Err(_) => { assert(false, "alice DH failed") }
    }
    return 0
}
