// Tests for crypto hash functions
use test::{assert, assert_eq}
use std::crypto::hash::{sha256, sha512, sha384, sha1, md5, sha512_256, md5_bytes, sha1_bytes, sha256_bytes, sha384_bytes, sha512_bytes, sha512_256_bytes}
use std::crypto::hash::{Hash, HashAlgorithm, Digest}
use std::collections::Buffer

// --- One-shot hash functions ---

@test
func test_sha256_empty_string() -> I32 {
    let mut digest: Digest = sha256("")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855", "sha256 empty")
    digest.destroy()
    return 0
}

@test
func test_sha256_hello_world() -> I32 {
    let mut digest: Digest = sha256("hello world")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9", "sha256 hello world")
    digest.destroy()
    return 0
}

@test
func test_sha256_hello() -> I32 {
    let mut digest: Digest = sha256("hello")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824", "sha256 hello")
    digest.destroy()
    return 0
}

@test
func test_sha512_empty_string() -> I32 {
    let mut digest: Digest = sha512("")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e", "sha512 empty")
    digest.destroy()
    return 0
}

@test
func test_sha512_hello() -> I32 {
    let mut digest: Digest = sha512("hello")
    let hex: Str = digest.to_hex()
    assert(hex.len() == (128 as I64), "sha512 produces 128 hex chars")
    digest.destroy()
    return 0
}

@test
func test_sha384_empty_string() -> I32 {
    let mut digest: Digest = sha384("")
    let hex: Str = digest.to_hex()
    assert(hex.len() == (96 as I64), "sha384 produces 96 hex chars")
    digest.destroy()
    return 0
}

@test
func test_sha1_empty_string() -> I32 {
    let mut digest: Digest = sha1("")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "da39a3ee5e6b4b0d3255bfef95601890afd80709", "sha1 empty")
    digest.destroy()
    return 0
}

@test
func test_sha1_hello() -> I32 {
    let mut digest: Digest = sha1("hello")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "aaf4c61ddcc5e8a2dabede0f3b482cd9aea9434d", "sha1 hello")
    digest.destroy()
    return 0
}

@test
func test_md5_empty_string() -> I32 {
    let mut digest: Digest = md5("")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "d41d8cd98f00b204e9800998ecf8427e", "md5 empty")
    digest.destroy()
    return 0
}

@test
func test_md5_hello() -> I32 {
    let mut digest: Digest = md5("hello")
    let hex: Str = digest.to_hex()
    assert_eq(hex, "5d41402abc4b2a76b9719d911017c592", "md5 hello")
    digest.destroy()
    return 0
}

@test
func test_sha512_256_empty() -> I32 {
    let mut digest: Digest = sha512_256("")
    let hex: Str = digest.to_hex()
    assert(hex.len() == (64 as I64), "sha512-256 produces 64 hex chars")
    digest.destroy()
    return 0
}

// --- Streaming Hash API ---

@test
func test_hash_streaming_sha256() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Sha256)
    hash.update("hello")
    hash.update(" ")
    hash.update("world")
    let mut digest: Digest = hash.digest()
    let hex: Str = digest.to_hex()
    assert_eq(hex, "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9", "streaming sha256")
    digest.destroy()
    hash.destroy()
    return 0
}

@test
func test_hash_algorithm_md5() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Md5)
    hash.update("hello")
    let mut digest: Digest = hash.digest()
    assert_eq(digest.to_hex(), "5d41402abc4b2a76b9719d911017c592", "streaming md5")
    digest.destroy()
    hash.destroy()
    return 0
}

// --- Digest encoding ---

@test
func test_digest_to_base64() -> I32 {
    let mut digest: Digest = sha256("hello")
    let base64: Str = digest.to_base64()
    assert_eq(base64, "LPJNul+wow4m6DsqxbninhsWHlwfp0JecwQzYpOLmCQ=", "sha256 base64")
    digest.destroy()
    return 0
}

// --- HashAlgorithm::name ---

@test
func test_hash_algorithm_names() -> I32 {
    assert_eq(HashAlgorithm::Md5.name(), "md5", "MD5 name")
    assert_eq(HashAlgorithm::Sha1.name(), "sha1", "SHA-1 name")
    assert_eq(HashAlgorithm::Sha256.name(), "sha256", "SHA-256 name")
    assert_eq(HashAlgorithm::Sha384.name(), "sha384", "SHA-384 name")
    assert_eq(HashAlgorithm::Sha512.name(), "sha512", "SHA-512 name")
    assert_eq(HashAlgorithm::Sha512_256.name(), "sha512-256", "SHA-512/256 name")
    return 0
}

// --- HashAlgorithm::digest_size ---

@test
func test_hash_algorithm_digest_size() -> I32 {
    assert_eq(HashAlgorithm::Md5.digest_size(), 16 as I64, "MD5 digest size")
    assert_eq(HashAlgorithm::Sha1.digest_size(), 20 as I64, "SHA1 digest size")
    assert_eq(HashAlgorithm::Sha256.digest_size(), 32 as I64, "SHA256 digest size")
    assert_eq(HashAlgorithm::Sha384.digest_size(), 48 as I64, "SHA384 digest size")
    assert_eq(HashAlgorithm::Sha512.digest_size(), 64 as I64, "SHA512 digest size")
    assert_eq(HashAlgorithm::Sha512_256.digest_size(), 32 as I64, "SHA512_256 digest size")
    return 0
}

// --- HashAlgorithm::block_size ---

@test
func test_hash_algorithm_block_size() -> I32 {
    assert_eq(HashAlgorithm::Md5.block_size(), 64 as I64, "MD5 block size")
    assert_eq(HashAlgorithm::Sha1.block_size(), 64 as I64, "SHA1 block size")
    assert_eq(HashAlgorithm::Sha256.block_size(), 64 as I64, "SHA256 block size")
    assert_eq(HashAlgorithm::Sha384.block_size(), 128 as I64, "SHA384 block size")
    assert_eq(HashAlgorithm::Sha512.block_size(), 128 as I64, "SHA512 block size")
    assert_eq(HashAlgorithm::Sha512_256.block_size(), 128 as I64, "SHA512_256 block size")
    return 0
}

// --- Digest::bytes ---

@test
func test_digest_bytes() -> I32 {
    let d: Digest = sha256("test")
    let b: ref Buffer = d.bytes()
    assert(b.len() > (0 as I64), "digest bytes should have length > 0")
    return 0
}

// --- Hash::copy ---

@test
func test_hash_copy() -> I32 {
    let h1: Hash = Hash::create(HashAlgorithm::Sha256)
    h1.update("hello")
    let h2: Hash = h1.copy()
    h1.update(" world")
    h2.update(" there")
    let d1: Digest = h1.digest()
    let d2: Digest = h2.digest()
    let hex1: Str = d1.to_hex()
    let hex2: Str = d2.to_hex()
    assert(hex1 != hex2, "copied hashes with different data should differ")
    h1.destroy()
    h2.destroy()
    return 0
}

// --- Hash::update_bytes ---

@test
func test_hash_update_bytes() -> I32 {
    let buf: Buffer = Buffer.new(5)
    buf.write_u8(0x68, 0)
    buf.write_u8(0x69, 1)
    let h: Hash = Hash::create(HashAlgorithm::Sha256)
    h.update_bytes(ref buf)
    let d: Digest = h.digest()
    let hex: Str = d.to_hex()
    assert(hex.len() > 0, "update_bytes should produce a valid hash")
    h.destroy()
    buf.destroy()
    return 0
}

// --- One-shot *_bytes functions ---

@test
func test_md5_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    buf.write_u8(0x42, 1)
    let d: Digest = md5_bytes(ref buf)
    assert(d.to_hex().len() > 0, "md5_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha1_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha1_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha1_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha256_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha256_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha256_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha384_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha384_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha384_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha512_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha512_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha512_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha512_256_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha512_256_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha512_256_bytes hex")
    buf.destroy()
    return 0
}

// --- Hash determinism ---

@test
func test_hash_determinism() -> I32 {
    let d1: Digest = sha256("same input")
    let d2: Digest = sha256("same input")
    assert_eq(d1.to_hex(), d2.to_hex(), "sha256 is deterministic")
    return 0
}

@test
func test_hash_different_inputs() -> I32 {
    let d1: Digest = sha256("input1")
    let d2: Digest = sha256("input2")
    assert(d1.to_hex() != d2.to_hex(), "different inputs produce different hashes")
    return 0
}

// --- Streaming all algorithms ---

@test
func test_hash_streaming_sha512() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Sha512)
    hash.update("hello")
    hash.update(" ")
    hash.update("world")
    let mut digest: Digest = hash.digest()

    let mut oneshot: Digest = sha512("hello world")
    assert_eq(digest.to_hex(), oneshot.to_hex(), "streaming sha512 matches oneshot")

    digest.destroy()
    oneshot.destroy()
    hash.destroy()
    return 0
}

@test
func test_hash_streaming_sha384() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Sha384)
    hash.update("test")
    hash.update(" data")
    let mut digest: Digest = hash.digest()

    let mut oneshot: Digest = sha384("test data")
    assert_eq(digest.to_hex(), oneshot.to_hex(), "streaming sha384 matches oneshot")

    digest.destroy()
    oneshot.destroy()
    hash.destroy()
    return 0
}

@test
func test_hash_streaming_sha1() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Sha1)
    hash.update("abc")
    let mut digest: Digest = hash.digest()

    let mut oneshot: Digest = sha1("abc")
    assert_eq(digest.to_hex(), oneshot.to_hex(), "streaming sha1 matches oneshot")

    digest.destroy()
    oneshot.destroy()
    hash.destroy()
    return 0
}

@test
func test_hash_streaming_sha512_256() -> I32 {
    let mut hash: Hash = Hash::create(HashAlgorithm::Sha512_256)
    hash.update("test")
    let mut digest: Digest = hash.digest()

    let mut oneshot: Digest = sha512_256("test")
    assert_eq(digest.to_hex(), oneshot.to_hex(), "streaming sha512-256 matches oneshot")

    digest.destroy()
    oneshot.destroy()
    hash.destroy()
    return 0
}

// --- Known test vectors ---

@test
func test_sha256_abc() -> I32 {
    let mut digest: Digest = sha256("abc")
    assert_eq(digest.to_hex(), "ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad", "sha256 abc")
    digest.destroy()
    return 0
}

@test
func test_sha384_known() -> I32 {
    let mut digest: Digest = sha384("abc")
    assert_eq(digest.to_hex(), "cb00753f45a35e8bb5a03d699ac65007272c32ab0eded1631a8b605a43ff5bed8086072ba1e7cc2358baeca134c825a7", "sha384 abc")
    digest.destroy()
    return 0
}

@test
func test_sha1_abc() -> I32 {
    let mut digest: Digest = sha1("abc")
    assert_eq(digest.to_hex(), "a9993e364706816aba3e25717850c26c9cd0d89d", "sha1 abc")
    digest.destroy()
    return 0
}

@test
func test_md5_abc() -> I32 {
    let mut digest: Digest = md5("abc")
    assert_eq(digest.to_hex(), "900150983cd24fb0d6963f7d28e17f72", "md5 abc")
    digest.destroy()
    return 0
}

// --- Digest length verification ---

@test
func test_digest_lengths() -> I32 {
    let d_md5: Digest = md5("x")
    let d_sha1: Digest = sha1("x")
    let d_sha256: Digest = sha256("x")
    let d_sha384: Digest = sha384("x")
    let d_sha512: Digest = sha512("x")

    assert_eq(d_md5.bytes().len(), 16 as I64, "MD5 = 16 bytes")
    assert_eq(d_sha1.bytes().len(), 20 as I64, "SHA1 = 20 bytes")
    assert_eq(d_sha256.bytes().len(), 32 as I64, "SHA256 = 32 bytes")
    assert_eq(d_sha384.bytes().len(), 48 as I64, "SHA384 = 48 bytes")
    assert_eq(d_sha512.bytes().len(), 64 as I64, "SHA512 = 64 bytes")
    return 0
}

// --- Base64 known vectors ---

@test
func test_sha256_base64_empty() -> I32 {
    let mut d: Digest = sha256("")
    let b64: Str = d.to_base64()
    assert_eq(b64, "47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=", "sha256 empty base64")
    d.destroy()
    return 0
}
