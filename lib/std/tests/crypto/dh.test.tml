// Tests for crypto Diffie-Hellman key exchange
use test
use std::crypto::dh::{DhGroup, DiffieHellman, create_dh_group}

// === DhGroup enum tests ===

@test
func test_dh_group_names() -> I32 {
    assert_eq(DhGroup::Modp1.name(), "modp1", "modp1")
    assert_eq(DhGroup::Modp2.name(), "modp2", "modp2")
    assert_eq(DhGroup::Modp5.name(), "modp5", "modp5")
    assert_eq(DhGroup::Modp14.name(), "modp14", "modp14")
    assert_eq(DhGroup::Modp15.name(), "modp15", "modp15")
    assert_eq(DhGroup::Modp16.name(), "modp16", "modp16")
    assert_eq(DhGroup::Modp17.name(), "modp17", "modp17")
    assert_eq(DhGroup::Modp18.name(), "modp18", "modp18")
    assert_eq(DhGroup::Ffdhe2048.name(), "ffdhe2048", "ffdhe2048")
    assert_eq(DhGroup::Ffdhe3072.name(), "ffdhe3072", "ffdhe3072")
    return 0
}

@test
func test_dh_group_prime_bits() -> I32 {
    assert_eq(DhGroup::Modp1.prime_bits(), 768 as I64, "modp1 bits")
    assert_eq(DhGroup::Modp2.prime_bits(), 1024 as I64, "modp2 bits")
    assert_eq(DhGroup::Modp14.prime_bits(), 2048 as I64, "modp14 bits")
    assert_eq(DhGroup::Modp16.prime_bits(), 4096 as I64, "modp16 bits")
    assert_eq(DhGroup::Ffdhe2048.prime_bits(), 2048 as I64, "ffdhe2048 bits")
    assert_eq(DhGroup::Ffdhe4096.prime_bits(), 4096 as I64, "ffdhe4096 bits")
    return 0
}

@test
func test_dh_group_deprecated() -> I32 {
    assert_eq(DhGroup::Modp1.is_deprecated(), true, "modp1 deprecated")
    assert_eq(DhGroup::Modp2.is_deprecated(), true, "modp2 deprecated")
    assert_eq(DhGroup::Modp5.is_deprecated(), true, "modp5 deprecated")
    assert_eq(DhGroup::Modp14.is_deprecated(), false, "modp14 not deprecated")
    assert_eq(DhGroup::Ffdhe2048.is_deprecated(), false, "ffdhe2048 not deprecated")
    return 0
}

@test
func test_dh_group_from_name() -> I32 {
    assert_eq(DhGroup::from_name("modp14").is_just(), true, "modp14 found")
    assert_eq(DhGroup::from_name("ffdhe2048").is_just(), true, "ffdhe2048 found")
    assert_eq(DhGroup::from_name("unknown").is_nothing(), true, "unknown")
    return 0
}

// === DH FFI tests ===
// DISABLED: DH key generation takes ~15s (2048-bit), exceeds test runner
// timeout (20s) and blocks coverage runs indefinitely.
// Re-enable when test runner supports per-test timeout configuration.
//
// @test
// func test_dh_with_group_and_keys() -> I32 {
//     let mut dh = DiffieHellman::with_group(DhGroup::Modp14).unwrap()
//     assert_eq(dh.prime_length(), 2048 as I64, "prime length")
//     assert_eq(dh.check_params(), true, "params valid")
//     dh.generate_keys()
//     let pub_key = dh.public_key()
//     assert_eq(pub_key.len() > 0 as I64, true, "pub key not empty")
//     let p = dh.prime()
//     assert_eq(p.len() > 0 as I64, true, "prime not empty")
//     let g = dh.generator()
//     assert_eq(g.len() > 0 as I64, true, "generator not empty")
//     return 0
// }
