// Tests for uncovered crypto/hash functions
use test::{assert, assert_eq}
use std::crypto::hash::{HashAlgorithm, Hash, Digest, sha256, md5_bytes, sha1_bytes, sha256_bytes, sha384_bytes, sha512_bytes, sha512_256_bytes}
use std::collections::Buffer

// --- HashAlgorithm::digest_size ---

@test
func test_hash_algorithm_digest_size() -> I32 {
    assert_eq(HashAlgorithm::Md5.digest_size(), 16 as I64, "MD5 digest size")
    assert_eq(HashAlgorithm::Sha1.digest_size(), 20 as I64, "SHA1 digest size")
    assert_eq(HashAlgorithm::Sha256.digest_size(), 32 as I64, "SHA256 digest size")
    assert_eq(HashAlgorithm::Sha384.digest_size(), 48 as I64, "SHA384 digest size")
    assert_eq(HashAlgorithm::Sha512.digest_size(), 64 as I64, "SHA512 digest size")
    assert_eq(HashAlgorithm::Sha512_256.digest_size(), 32 as I64, "SHA512_256 digest size")
    return 0
}

// --- HashAlgorithm::block_size ---

@test
func test_hash_algorithm_block_size() -> I32 {
    assert_eq(HashAlgorithm::Md5.block_size(), 64 as I64, "MD5 block size")
    assert_eq(HashAlgorithm::Sha1.block_size(), 64 as I64, "SHA1 block size")
    assert_eq(HashAlgorithm::Sha256.block_size(), 64 as I64, "SHA256 block size")
    assert_eq(HashAlgorithm::Sha384.block_size(), 128 as I64, "SHA384 block size")
    assert_eq(HashAlgorithm::Sha512.block_size(), 128 as I64, "SHA512 block size")
    assert_eq(HashAlgorithm::Sha512_256.block_size(), 128 as I64, "SHA512_256 block size")
    return 0
}

// --- Digest::bytes ---

@test
func test_digest_bytes() -> I32 {
    let d: Digest = sha256("test")
    let b: ref Buffer = d.bytes()
    assert(b.len() > 0 as I64, "digest bytes should have length > 0")
    return 0
}

// --- Hash::copy ---

@test
func test_hash_copy() -> I32 {
    let h1: Hash = Hash::create(HashAlgorithm::Sha256)
    h1.update("hello")
    let h2: Hash = h1.copy()
    h1.update(" world")
    h2.update(" there")
    let d1: Digest = h1.digest()
    let d2: Digest = h2.digest()
    let hex1: Str = d1.to_hex()
    let hex2: Str = d2.to_hex()
    assert(hex1 != hex2, "copied hashes with different data should differ")
    h1.destroy()
    h2.destroy()
    return 0
}

// --- Hash::update_bytes ---

@test
func test_hash_update_bytes() -> I32 {
    let buf: Buffer = Buffer.new(5)
    buf.write_u8(0x68, 0)
    buf.write_u8(0x69, 1)
    let h: Hash = Hash::create(HashAlgorithm::Sha256)
    h.update_bytes(ref buf)
    let d: Digest = h.digest()
    let hex: Str = d.to_hex()
    assert(hex.len() > 0, "update_bytes should produce a valid hash")
    h.destroy()
    buf.destroy()
    return 0
}

// --- One-shot *_bytes functions ---

@test
func test_md5_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    buf.write_u8(0x42, 1)
    let d: Digest = md5_bytes(ref buf)
    assert(d.to_hex().len() > 0, "md5_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha1_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha1_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha1_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha256_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha256_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha256_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha384_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha384_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha384_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha512_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha512_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha512_bytes hex")
    buf.destroy()
    return 0
}

@test
func test_sha512_256_bytes() -> I32 {
    let buf: Buffer = Buffer.new(3)
    buf.write_u8(0x41, 0)
    let d: Digest = sha512_256_bytes(ref buf)
    assert(d.to_hex().len() > 0, "sha512_256_bytes hex")
    buf.destroy()
    return 0
}
