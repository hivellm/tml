// Extra tests for Deflate stream class
use test
use std::zlib::{deflate}
use std::zlib::stream::{Deflate, create_deflate, create_deflate_with_options}
use std::zlib::options::ZlibOptions
use std::zlib::error::ZlibError
use std::collections::Buffer

@test
func test_create_deflate() -> I32 {
    let result: Outcome[Deflate, ZlibError] = create_deflate()
    if result.is_err() {
        print("create_deflate failed\n")
        return 1
    }
    var defl: Deflate = result.unwrap()
    defl.destroy()
    return 0
}

@test
func test_create_deflate_with_options() -> I32 {
    let opts: ZlibOptions = ZlibOptions::default().with_level(6)
    let result: Outcome[Deflate, ZlibError] = create_deflate_with_options(opts)
    if result.is_err() {
        print("create_deflate_with_options failed\n")
        return 1
    }
    var defl: Deflate = result.unwrap()
    defl.destroy()
    return 0
}

@test
func test_deflate_write_buffer() -> I32 {
    // First create a buffer with data
    let compress_result: Outcome[Buffer, ZlibError] = deflate("source data to compress")
    if compress_result.is_err() {
        return 1
    }
    var data_buffer: Buffer = compress_result.unwrap()

    // Create deflate stream
    let result: Outcome[Deflate, ZlibError] = Deflate::new()
    if result.is_err() {
        return 1
    }
    let defl: Deflate = result.unwrap()

    // Write buffer
    let write_result: Outcome[Buffer, ZlibError] = defl.write_buffer(ref data_buffer)
    if write_result.is_err() {
        print("Deflate::write_buffer failed\n")
        defl.destroy()
        return 1
    }

    defl.destroy()
    return 0
}

@test
func test_deflate_params() -> I32 {
    let result: Outcome[Deflate, ZlibError] = Deflate::new()
    if result.is_err() {
        return 1
    }
    let defl: Deflate = result.unwrap()

    // Change compression parameters
    let params_result: Outcome[Buffer, ZlibError] = defl.params(6, 1)
    if params_result.is_err() {
        // Some implementations may not support params change
        print("Deflate::params not supported\n")
    }

    defl.destroy()
    return 0
}

@test
func test_deflate_bytes_written() -> I32 {
    let result: Outcome[Deflate, ZlibError] = Deflate::new()
    if result.is_err() {
        return 1
    }
    let defl: Deflate = result.unwrap()

    // Check bytes_written before and after writing
    let initial: I64 = defl.bytes_written()
    assert_eq(initial, 0, "should be 0 initially")

    // Write some data
    let write_result: Outcome[Buffer, ZlibError] = defl.write("Test data")
    if write_result.is_ok() {
        let finish_result: Outcome[Buffer, ZlibError] = defl.finish()
        if finish_result.is_ok() {
            let after: I64 = defl.bytes_written()
            if after > 0 {
                assert(true, "bytes_written increased after writing")
            }
        }
    }

    defl.destroy()
    return 0
}
