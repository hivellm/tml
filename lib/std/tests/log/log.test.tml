// Consolidated tests for std::log (39 tests)

use std::log
use std::log::{TRACE, DEBUG, INFO, WARN, ERROR, FATAL}
use std::log::{FORMAT_TEXT, FORMAT_JSON, FORMAT_COMPACT}
use std::file::path::Path
use test::{assert, assert_eq}

// ============================================================================
// Log Level Constants (from log_basic)
// ============================================================================

@test
func test_log_const_trace() -> I32 {
    assert_eq(TRACE, 0, "TRACE should be 0")
    return 0
}

@test
func test_log_const_debug() -> I32 {
    assert_eq(DEBUG, 1, "DEBUG should be 1")
    return 0
}

@test
func test_log_const_info() -> I32 {
    assert_eq(INFO, 2, "INFO should be 2")
    return 0
}

@test
func test_log_const_warn() -> I32 {
    assert_eq(WARN, 3, "WARN should be 3")
    return 0
}

@test
func test_log_const_error() -> I32 {
    assert_eq(ERROR, 4, "ERROR should be 4")
    return 0
}

@test
func test_log_const_fatal() -> I32 {
    assert_eq(FATAL, 5, "FATAL should be 5")
    return 0
}

// ============================================================================
// Set/Get Level (from log_basic)
// ============================================================================

@test
func test_log_set_get_level_debug() -> I32 {
    log::set_level(DEBUG)
    assert_eq(log::get_level(), DEBUG, "level should be DEBUG after set")
    log::set_level(WARN)
    return 0
}

@test
func test_log_set_get_level_trace() -> I32 {
    log::set_level(TRACE)
    assert_eq(log::get_level(), TRACE, "level should be TRACE")
    log::set_level(WARN)
    return 0
}

@test
func test_log_set_get_level_error() -> I32 {
    log::set_level(ERROR)
    assert_eq(log::get_level(), ERROR, "level should be ERROR")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// Enabled Checks (from log_basic)
// ============================================================================

@test
func test_log_enabled_at_warn() -> I32 {
    log::set_level(WARN)
    assert(log::enabled(WARN), "WARN should be enabled at WARN level")
    assert(log::enabled(ERROR), "ERROR should be enabled at WARN level")
    assert(log::enabled(FATAL), "FATAL should be enabled at WARN level")
    log::set_level(WARN)
    return 0
}

@test
func test_log_disabled_below_level() -> I32 {
    log::set_level(WARN)
    assert(not log::enabled(TRACE), "TRACE should be disabled at WARN level")
    assert(not log::enabled(DEBUG), "DEBUG should be disabled at WARN level")
    assert(not log::enabled(INFO), "INFO should be disabled at WARN level")
    log::set_level(WARN)
    return 0
}

@test
func test_log_all_enabled_at_trace() -> I32 {
    log::set_level(TRACE)
    assert(log::enabled(TRACE), "TRACE enabled at TRACE level")
    assert(log::enabled(DEBUG), "DEBUG enabled at TRACE level")
    assert(log::enabled(INFO), "INFO enabled at TRACE level")
    assert(log::enabled(WARN), "WARN enabled at TRACE level")
    assert(log::enabled(ERROR), "ERROR enabled at TRACE level")
    assert(log::enabled(FATAL), "FATAL enabled at TRACE level")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// Basic Log Calls (from log_basic)
// ============================================================================

@test
func test_log_trace_call() -> I32 {
    log::set_level(TRACE)
    log::trace("test", "trace message")
    log::set_level(WARN)
    return 0
}

@test
func test_log_debug_call() -> I32 {
    log::set_level(DEBUG)
    log::debug("test", "debug message")
    log::set_level(WARN)
    return 0
}

@test
func test_log_info_call() -> I32 {
    log::set_level(INFO)
    log::info("test", "info message")
    log::set_level(WARN)
    return 0
}

@test
func test_log_warn_call() -> I32 {
    log::warn("test", "warn message")
    return 0
}

@test
func test_log_error_call() -> I32 {
    log::error("test", "error message")
    return 0
}

@test
func test_log_fatal_call() -> I32 {
    log::fatal("test", "fatal message")
    return 0
}

@test
func test_log_generic_call() -> I32 {
    log::msg(INFO, "mymod", "generic log call")
    log::set_level(WARN)
    return 0
}

@test
func test_log_filtered_no_crash() -> I32 {
    log::set_level(ERROR)
    log::trace("test", "should be filtered")
    log::debug("test", "should be filtered")
    log::info("test", "should be filtered")
    log::warn("test", "should be filtered")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// Format Constants (from log_advanced)
// ============================================================================

@test
func test_format_text_const() -> I32 {
    assert_eq(FORMAT_TEXT, 0, "FORMAT_TEXT should be 0")
    return 0
}

@test
func test_format_json_const() -> I32 {
    assert_eq(FORMAT_JSON, 1, "FORMAT_JSON should be 1")
    return 0
}

@test
func test_format_compact_const() -> I32 {
    assert_eq(FORMAT_COMPACT, 2, "FORMAT_COMPACT should be 2")
    return 0
}

// ============================================================================
// Output Format (from log_advanced, 4.4.2)
// ============================================================================

@test
func test_set_get_format_text() -> I32 {
    log::set_format(FORMAT_TEXT)
    assert_eq(log::get_format(), FORMAT_TEXT, "format should be TEXT")
    return 0
}

@test
func test_set_get_format_json() -> I32 {
    log::set_format(FORMAT_JSON)
    assert_eq(log::get_format(), FORMAT_JSON, "format should be JSON")
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_set_get_format_compact() -> I32 {
    log::set_format(FORMAT_COMPACT)
    assert_eq(log::get_format(), FORMAT_COMPACT, "format should be COMPACT")
    log::set_format(FORMAT_TEXT)
    return 0
}

// ============================================================================
// Module-Level Filtering (from log_advanced, 4.4.3)
// ============================================================================

@test
func test_set_filter_module_enabled() -> I32 {
    log::set_filter("db=trace,*=warn")
    assert(log::module_enabled(TRACE, "db"), "db TRACE should be enabled")
    assert(log::module_enabled(DEBUG, "db"), "db DEBUG should be enabled")
    assert(log::module_enabled(WARN, "db"), "db WARN should be enabled")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_set_filter_default_level() -> I32 {
    log::set_filter("server=debug,*=error")
    assert(not log::module_enabled(TRACE, "app"), "app TRACE should be disabled (default=error)")
    assert(not log::module_enabled(WARN, "app"), "app WARN should be disabled (default=error)")
    assert(log::module_enabled(ERROR, "app"), "app ERROR should be enabled (default=error)")
    assert(log::module_enabled(DEBUG, "server"), "server DEBUG should be enabled")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_set_filter_bare_module() -> I32 {
    log::set_filter("mymod")
    assert(log::module_enabled(TRACE, "mymod"), "bare module should enable TRACE")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_filter_empty_string() -> I32 {
    log::set_level(INFO)
    log::set_filter("")
    assert(log::module_enabled(INFO, "anything"), "INFO should be enabled after empty filter")
    log::set_level(WARN)
    return 0
}

@test
func test_filter_log_call_no_crash() -> I32 {
    log::set_filter("test=trace,*=error")
    log::set_level(TRACE)
    log::trace("test", "should pass filter")
    log::debug("test", "should pass filter")
    log::trace("other", "should be filtered out")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// Structured Logging (from log_advanced, 4.4.4)
// ============================================================================

@test
func test_structured_log_no_crash() -> I32 {
    log::set_level(TRACE)
    log::structured(INFO, "http", "Request handled", "method=GET;status=200;ms=42")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_empty_fields() -> I32 {
    log::set_level(TRACE)
    log::structured(WARN, "app", "Something happened", "")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_single_field() -> I32 {
    log::set_level(TRACE)
    log::structured(ERROR, "db", "Query failed", "query=SELECT * FROM users")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_json_format() -> I32 {
    log::set_format(FORMAT_JSON)
    log::set_level(TRACE)
    log::structured(INFO, "http", "Request", "method=POST;path=/api;status=201")
    log::set_level(WARN)
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_structured_log_compact_format() -> I32 {
    log::set_format(FORMAT_COMPACT)
    log::set_level(TRACE)
    log::structured(DEBUG, "cache", "Hit", "key=user:123;ttl=3600")
    log::set_level(WARN)
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_structured_filtered_no_crash() -> I32 {
    log::set_level(ERROR)
    log::structured(DEBUG, "app", "Should be filtered", "key=value")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// File Sink (from log_advanced, 4.4.6)
// ============================================================================

@test
func test_open_close_file_no_crash() -> I32 {
    let path: Str = "build/debug/_tml_test_log.tmp"
    log::set_level(TRACE)
    let opened = log::open_file(path)
    if opened {
        log::info("test", "Writing to file sink")
        log::close_file()
    }
    log::set_level(WARN)
    Path::remove(path)
    return 0
}

@test
func test_close_file_without_open() -> I32 {
    // Should not crash
    log::close_file()
    return 0
}

// ============================================================================
// Environment Variable Configuration (from log_advanced, 4.4.7)
// ============================================================================

@test
func test_init_from_env_no_crash() -> I32 {
    // TML_LOG may or may not be set â€” just verify no crash
    let _applied = log::init_from_env()
    // Reset to known state
    log::set_level(WARN)
    log::set_filter("")
    return 0
}

// ============================================================================
// Combined Features (from log_advanced)
// ============================================================================

@test
func test_json_structured_with_filter() -> I32 {
    log::set_format(FORMAT_JSON)
    log::set_filter("api=debug,*=error")
    log::set_level(TRACE)
    log::structured(DEBUG, "api", "Endpoint called", "path=/users;method=GET")
    log::structured(DEBUG, "internal", "Should be filtered", "key=val")
    log::set_level(WARN)
    log::set_filter("")
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_all_formats_basic_output() -> I32 {
    log::set_level(TRACE)

    log::set_format(FORMAT_TEXT)
    log::info("fmt", "text format")

    log::set_format(FORMAT_JSON)
    log::info("fmt", "json format")

    log::set_format(FORMAT_COMPACT)
    log::info("fmt", "compact format")

    log::set_format(FORMAT_TEXT)
    log::set_level(WARN)
    return 0
}
