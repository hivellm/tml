//! Advanced tests for std::log module (Phase 4.4).
//!
//! Tests module-level filtering, structured logging, output formats,
//! file sinks, and environment variable configuration.

use std::log
use std::log::{TRACE, DEBUG, INFO, WARN, ERROR, FATAL}
use std::log::{FORMAT_TEXT, FORMAT_JSON, FORMAT_COMPACT}
use test::{assert, assert_eq}

// ============================================================================
// Format Constants
// ============================================================================

@test
func test_format_text_const() -> I32 {
    assert_eq(FORMAT_TEXT, 0, "FORMAT_TEXT should be 0")
    return 0
}

@test
func test_format_json_const() -> I32 {
    assert_eq(FORMAT_JSON, 1, "FORMAT_JSON should be 1")
    return 0
}

@test
func test_format_compact_const() -> I32 {
    assert_eq(FORMAT_COMPACT, 2, "FORMAT_COMPACT should be 2")
    return 0
}

// ============================================================================
// Output Format (4.4.2)
// ============================================================================

@test
func test_set_get_format_text() -> I32 {
    log::set_format(FORMAT_TEXT)
    assert_eq(log::get_format(), FORMAT_TEXT, "format should be TEXT")
    return 0
}

@test
func test_set_get_format_json() -> I32 {
    log::set_format(FORMAT_JSON)
    assert_eq(log::get_format(), FORMAT_JSON, "format should be JSON")
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_set_get_format_compact() -> I32 {
    log::set_format(FORMAT_COMPACT)
    assert_eq(log::get_format(), FORMAT_COMPACT, "format should be COMPACT")
    log::set_format(FORMAT_TEXT)
    return 0
}

// ============================================================================
// Module-Level Filtering (4.4.3)
// ============================================================================

@test
func test_set_filter_module_enabled() -> I32 {
    log::set_filter("db=trace,*=warn")
    assert(log::module_enabled(TRACE, "db"), "db TRACE should be enabled")
    assert(log::module_enabled(DEBUG, "db"), "db DEBUG should be enabled")
    assert(log::module_enabled(WARN, "db"), "db WARN should be enabled")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_set_filter_default_level() -> I32 {
    log::set_filter("server=debug,*=error")
    assert(not log::module_enabled(TRACE, "app"), "app TRACE should be disabled (default=error)")
    assert(not log::module_enabled(WARN, "app"), "app WARN should be disabled (default=error)")
    assert(log::module_enabled(ERROR, "app"), "app ERROR should be enabled (default=error)")
    assert(log::module_enabled(DEBUG, "server"), "server DEBUG should be enabled")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_set_filter_bare_module() -> I32 {
    log::set_filter("mymod")
    assert(log::module_enabled(TRACE, "mymod"), "bare module should enable TRACE")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

@test
func test_filter_empty_string() -> I32 {
    log::set_level(INFO)
    log::set_filter("")
    assert(log::module_enabled(INFO, "anything"), "INFO should be enabled after empty filter")
    log::set_level(WARN)
    return 0
}

@test
func test_filter_log_call_no_crash() -> I32 {
    log::set_filter("test=trace,*=error")
    log::set_level(TRACE)
    log::trace("test", "should pass filter")
    log::debug("test", "should pass filter")
    log::trace("other", "should be filtered out")
    // Reset
    log::set_filter("")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// Structured Logging (4.4.4)
// ============================================================================

@test
func test_structured_log_no_crash() -> I32 {
    log::set_level(TRACE)
    log::structured(INFO, "http", "Request handled", "method=GET;status=200;ms=42")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_empty_fields() -> I32 {
    log::set_level(TRACE)
    log::structured(WARN, "app", "Something happened", "")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_single_field() -> I32 {
    log::set_level(TRACE)
    log::structured(ERROR, "db", "Query failed", "query=SELECT * FROM users")
    log::set_level(WARN)
    return 0
}

@test
func test_structured_log_json_format() -> I32 {
    log::set_format(FORMAT_JSON)
    log::set_level(TRACE)
    log::structured(INFO, "http", "Request", "method=POST;path=/api;status=201")
    log::set_level(WARN)
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_structured_log_compact_format() -> I32 {
    log::set_format(FORMAT_COMPACT)
    log::set_level(TRACE)
    log::structured(DEBUG, "cache", "Hit", "key=user:123;ttl=3600")
    log::set_level(WARN)
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_structured_filtered_no_crash() -> I32 {
    log::set_level(ERROR)
    log::structured(DEBUG, "app", "Should be filtered", "key=value")
    log::set_level(WARN)
    return 0
}

// ============================================================================
// File Sink (4.4.6)
// ============================================================================

@test
func test_open_close_file_no_crash() -> I32 {
    log::set_level(TRACE)
    // Use a temp path that should be writable
    let opened = log::open_file("build/debug/_tml_test_log.tmp")
    if opened {
        log::info("test", "Writing to file sink")
        log::close_file()
    }
    log::set_level(WARN)
    return 0
}

@test
func test_close_file_without_open() -> I32 {
    // Should not crash
    log::close_file()
    return 0
}

// ============================================================================
// Environment Variable Configuration (4.4.7)
// ============================================================================

@test
func test_init_from_env_no_crash() -> I32 {
    // TML_LOG may or may not be set â€” just verify no crash
    let _applied = log::init_from_env()
    // Reset to known state
    log::set_level(WARN)
    log::set_filter("")
    return 0
}

// ============================================================================
// Combined Features
// ============================================================================

@test
func test_json_structured_with_filter() -> I32 {
    log::set_format(FORMAT_JSON)
    log::set_filter("api=debug,*=error")
    log::set_level(TRACE)
    log::structured(DEBUG, "api", "Endpoint called", "path=/users;method=GET")
    log::structured(DEBUG, "internal", "Should be filtered", "key=val")
    log::set_level(WARN)
    log::set_filter("")
    log::set_format(FORMAT_TEXT)
    return 0
}

@test
func test_all_formats_basic_output() -> I32 {
    log::set_level(TRACE)

    log::set_format(FORMAT_TEXT)
    log::info("fmt", "text format")

    log::set_format(FORMAT_JSON)
    log::info("fmt", "json format")

    log::set_format(FORMAT_COMPACT)
    log::info("fmt", "compact format")

    log::set_format(FORMAT_TEXT)
    log::set_level(WARN)
    return 0
}
