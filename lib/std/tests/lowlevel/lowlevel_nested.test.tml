// Nested Pointer Dereference with Smart Pointers Tests
use test::{assert, assert_eq}
use std::sync::{Mutex, MutexGuard, Arc}

type Node[T] {
    value: T,
    next: Ptr[Node[T]],
}

// ============================================================================
// Section 5: Nested Pointer Dereference with Smart Pointers
// ============================================================================

func set_next_simple(guard: ref MutexGuard[Ptr[Node[I32]]], new_next: Ptr[Node[I32]]) {
    lowlevel {
        (*(*guard)).next = new_next
    }
}

@test
func test_nested_deref_simple() -> I32 {
    var node1: Node[I32] = Node { value: 1, next: null }
    var node2: Node[I32] = Node { value: 2, next: null }

    let ptr1: Ptr[Node[I32]] = ref node1 as Ptr[Node[I32]]
    let ptr2: Ptr[Node[I32]] = ref node2 as Ptr[Node[I32]]

    var mutex: Mutex[Ptr[Node[I32]]] = Mutex::new(ptr1)
    let guard: MutexGuard[Ptr[Node[I32]]] = mutex.lock()

    set_next_simple(ref guard, ptr2)

    assert_eq(node1.next as I64, ptr2 as I64)
    return 0
}

@test
func test_nested_deref_debug() -> I32 {
    var node1: Node[I32] = Node { value: 1, next: null }
    var node2: Node[I32] = Node { value: 2, next: null }

    let ptr1: Ptr[Node[I32]] = ref node1 as Ptr[Node[I32]]
    let ptr2: Ptr[Node[I32]] = ref node2 as Ptr[Node[I32]]

    var mutex: Mutex[Ptr[Node[I32]]] = Mutex::new(ptr1)
    let guard: MutexGuard[Ptr[Node[I32]]] = mutex.lock()

    lowlevel {
        (*(*guard)).next = ptr2
    }

    assert_eq(node1.next as I64, ptr2 as I64)
    return 0
}

// ============================================================================
// Section 6: Arc[Ptr[T]] Operations
// ============================================================================

type SimpleData {
    value: I32,
}

@test
func test_arc_ptr_deref() -> I32 {
    var data: SimpleData = SimpleData { value: 10 }
    let ptr: Ptr[SimpleData] = ref data as Ptr[SimpleData]
    let arc: Arc[Ptr[SimpleData]] = Arc::new(ptr)

    lowlevel {
        (*(*arc)).value = 42
    }

    assert_eq(data.value, 42)
    return 0
}
