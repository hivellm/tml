// Arc method tests - strong_count, weak_count, downgrade, ptr_eq, etc.
use test::{assert, assert_eq}
use std::sync::{Arc, Weak}

// ============================================================================
// Strong Count Tests
// ============================================================================

@test
func test_arc_strong_count_initial() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    assert_eq(arc.strong_count(), 1 as I64)
    return 0
}

@test
func test_arc_strong_count_after_duplicate() -> I32 {
    let arc1: Arc[I32] = Arc::new(42)
    let arc2: Arc[I32] = arc1.duplicate()
    assert_eq(arc1.strong_count(), 2 as I64)
    assert_eq(arc2.strong_count(), 2 as I64)
    return 0
}

@test
func test_arc_strong_count_after_multiple_duplicates() -> I32 {
    let arc1: Arc[I32] = Arc::new(42)
    let arc2: Arc[I32] = arc1.duplicate()
    let arc3: Arc[I32] = arc1.duplicate()
    assert_eq(arc1.strong_count(), 3 as I64)
    return 0
}

// ============================================================================
// Weak Reference Tests
// ============================================================================

@test
func test_arc_downgrade() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    let weak: Weak[I32] = arc.downgrade()
    assert_eq(arc.weak_count(), 1 as I64)
    return 0
}

// DISABLED: Needs auto-drop glue for Maybe[Arc[I32]] (enum with non-trivial payload)
// @test
// func test_weak_upgrade_success() -> I32 {
//     let arc: Arc[I32] = Arc::new(42)
//     let weak: Weak[I32] = arc.downgrade()
//
//     when weak.upgrade() {
//         Just(upgraded) => {
//             assert_eq(arc.strong_count(), 2 as I64)
//         },
//         Nothing => assert(false, "upgrade should succeed while Arc exists")
//     }
//     return 0
// }

@test
func test_weak_strong_count() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    let weak: Weak[I32] = arc.downgrade()
    assert_eq(weak.strong_count(), 1 as I64)
    return 0
}

@test
func test_weak_weak_count() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    let weak1: Weak[I32] = arc.downgrade()
    let weak2: Weak[I32] = arc.downgrade()
    assert_eq(weak1.weak_count(), 2 as I64)
    return 0
}

@test
func test_weak_new() -> I32 {
    let weak: Weak[I32] = Weak::new[I32]()
    assert_eq(weak.strong_count(), 0 as I64)
    return 0
}

// DISABLED: Needs auto-drop glue for Maybe[Arc[I32]] (enum with non-trivial payload)
// @test
// func test_weak_new_upgrade_fails() -> I32 {
//     let weak: Weak[I32] = Weak::new[I32]()
//     when weak.upgrade() {
//         Just(_) => assert(false, "upgrade should fail for dangling weak"),
//         Nothing => {}
//     }
//     return 0
// }

@test
func test_weak_duplicate() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    let weak1: Weak[I32] = arc.downgrade()
    let weak2: Weak[I32] = weak1.duplicate()
    assert_eq(arc.weak_count(), 2 as I64)
    return 0
}

// Note: ptr_eq tests disabled due to codegen issue with passing Arc by value to methods
// ============================================================================
// Pointer Equality Tests - DISABLED
// ============================================================================

// ============================================================================
// Arc::get Tests
// ============================================================================

@test
func test_arc_get() -> I32 {
    let arc: Arc[I32] = Arc::new(42)
    let val: ref I32 = arc.get()
    assert_eq(*val, 42)
    return 0
}

// ============================================================================
// Arc with Different Types
// ============================================================================

type Point { x: I32, y: I32 }

@test
func test_arc_with_struct_strong_count() -> I32 {
    let arc1: Arc[Point] = Arc::new(Point { x: 1, y: 2 })
    let arc2: Arc[Point] = arc1.duplicate()
    assert_eq(arc1.strong_count(), 2 as I64)
    return 0
}

@test
func test_arc_with_struct_weak() -> I32 {
    let arc: Arc[Point] = Arc::new(Point { x: 1, y: 2 })
    let weak: Weak[Point] = arc.downgrade()
    assert_eq(arc.weak_count(), 1 as I64)
    return 0
}
