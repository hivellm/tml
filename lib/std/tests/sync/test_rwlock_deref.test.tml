// Tests for std::sync::rwlock::RwLock â€” using .get()/.get_mut() API
// NOTE: Deref (*guard) on generic guard types triggers a codegen bug
// where %struct.RwLock__T is emitted unsized. Use .get()/.get_mut() instead.
use test::{assert, assert_eq}
use std::sync::rwlock::RwLock

@test
func test_rwlock_new_and_read() -> I32 {
    var rw: RwLock[I32] = RwLock::new(42 as I32)
    let guard = rw.read()
    assert_eq(*guard.get(), 42 as I32, "new + read should return 42")
    return 0
}

@test
func test_rwlock_write_and_read() -> I32 {
    var rw: RwLock[I32] = RwLock::new(0 as I32)
    {
        let mut w = rw.write()
        *w.get_mut() = 77 as I32
    }
    let r = rw.read()
    assert_eq(*r.get(), 77 as I32, "write then read should return 77")
    return 0
}
