//! Socket address types.
//!
//! This module provides socket address types that combine an IP address with
//! a port number. These types are platform-independent and work in `no_std`
//! environments.
//!
//! # Types
//!
//! - [`SocketAddrV4`] - IPv4 socket address (IP + port)
//! - [`SocketAddrV6`] - IPv6 socket address (IP + port + flow info + scope ID)
//! - [`SocketAddr`] - An enum that holds either V4 or V6
//!
//! # Examples
//!
//! ```tml
//! use core::net::socket::{SocketAddr, SocketAddrV4, SocketAddrV6}
//! use core::net::ip::{Ipv4Addr, Ipv6Addr}
//!
//! // Create socket addresses
//! let v4 = SocketAddrV4::new(Ipv4Addr::LOCALHOST, 8080)
//! let v6 = SocketAddrV6::new(Ipv6Addr::LOCALHOST, 8080, 0, 0)
//!
//! // Access components
//! assert(v4.port() == 8080)
//! assert(v4.ip().is_loopback())
//!
//! // Use the unified type
//! let addr: SocketAddr = SocketAddr::V4(v4)
//! ```

use core::cmp::{Eq, Ord, Ordering, PartialEq, PartialOrd}
use core::clone::{Copy, Duplicate}
use core::hash::{Hash, Hasher}
use core::fmt::{Debug, Display, Formatter, FormatResult}
use core::option::Maybe::{Just, Nothing}

use super::ip::{IpAddr, Ipv4Addr, Ipv6Addr}

// =============================================================================
// SocketAddrV4 - IPv4 Socket Address
// =============================================================================

/// An IPv4 socket address.
///
/// Consists of an IPv4 address and a 16-bit port number.
///
/// # Examples
///
/// ```tml
/// let addr: SocketAddrV4 = SocketAddrV4::new(Ipv4Addr::LOCALHOST, 8080)
/// assert_eq(addr.ip(), Ipv4Addr::LOCALHOST)
/// assert_eq(addr.port(), 8080)
/// ```
pub type SocketAddrV4 {
    ip: Ipv4Addr,
    port: U16,
}

impl SocketAddrV4 {
    /// Creates a new socket address from an IPv4 address and a port number.
    pub func new(ip: Ipv4Addr, port: U16) -> SocketAddrV4 {
        SocketAddrV4 { ip, port }
    }

    /// Returns the IP address associated with this socket address.
    pub func ip(this) -> Ipv4Addr {
        this.ip
    }

    /// Returns a mutable reference to the IP address.
    pub func ip_mut(mut this) -> mut ref Ipv4Addr {
        mut ref this.ip
    }

    /// Sets the IP address.
    pub func set_ip(mut this, ip: Ipv4Addr) {
        this.ip = ip
    }

    /// Returns the port number associated with this socket address.
    pub func port(this) -> U16 {
        this.port
    }

    /// Sets the port number.
    pub func set_port(mut this, port: U16) {
        this.port = port
    }
}

// Behavior implementations for SocketAddrV4
impl Copy for SocketAddrV4 {}
impl Duplicate for SocketAddrV4 {
    func duplicate(this) -> SocketAddrV4 {
        SocketAddrV4 { ip: this.ip.duplicate(), port: this.port }
    }
}

impl PartialEq for SocketAddrV4 {
    func eq(this, other: ref SocketAddrV4) -> Bool {
        this.ip == other.ip and this.port == other.port
    }
}

impl Eq for SocketAddrV4 {}

impl PartialOrd for SocketAddrV4 {
    func partial_cmp(this, other: ref SocketAddrV4) -> Maybe[Ordering] {
        Just(this.cmp(other))
    }
}

impl Ord for SocketAddrV4 {
    func cmp(this, other: ref SocketAddrV4) -> Ordering {
        let ip_ord = this.ip.cmp(ref other.ip)
        if ip_ord != Ordering::Equal {
            ip_ord
        } else {
            if this.port < other.port { Ordering::Less }
            else if this.port > other.port { Ordering::Greater }
            else { Ordering::Equal }
        }
    }
}

impl Hash for SocketAddrV4 {
    func hash(this, hasher: mut ref Hasher) {
        this.ip.hash(hasher)
        hasher.write_u16(this.port)
    }
}

impl Display for SocketAddrV4 {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        this.ip.fmt(f)
        f.write_str(":")
        f.write_str(this.port.to_string())
    }
}

impl Debug for SocketAddrV4 {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        Display::fmt(this, f)
    }
}

// =============================================================================
// SocketAddrV6 - IPv6 Socket Address
// =============================================================================

/// An IPv6 socket address.
///
/// Consists of an IPv6 address, a 16-bit port number, and additional
/// IPv6-specific fields: flow info and scope ID.
///
/// # Examples
///
/// ```tml
/// let addr: SocketAddrV6 = SocketAddrV6::new(Ipv6Addr::LOCALHOST, 8080, 0, 0)
/// assert_eq(addr.ip(), Ipv6Addr::LOCALHOST)
/// assert_eq(addr.port(), 8080)
/// ```
pub type SocketAddrV6 {
    ip: Ipv6Addr,
    port: U16,
    flowinfo: U32,
    scope_id: U32,
}

impl SocketAddrV6 {
    /// Creates a new socket address from an IPv6 address, port, flow info, and scope ID.
    pub func new(ip: Ipv6Addr, port: U16, flowinfo: U32, scope_id: U32) -> SocketAddrV6 {
        SocketAddrV6 { ip, port, flowinfo, scope_id }
    }

    /// Returns the IP address associated with this socket address.
    pub func ip(this) -> Ipv6Addr {
        this.ip
    }

    /// Returns a mutable reference to the IP address.
    pub func ip_mut(mut this) -> mut ref Ipv6Addr {
        mut ref this.ip
    }

    /// Sets the IP address.
    pub func set_ip(mut this, ip: Ipv6Addr) {
        this.ip = ip
    }

    /// Returns the port number associated with this socket address.
    pub func port(this) -> U16 {
        this.port
    }

    /// Sets the port number.
    pub func set_port(mut this, port: U16) {
        this.port = port
    }

    /// Returns the flow info associated with this socket address.
    ///
    /// This field corresponds to the `sin6_flowinfo` field in C.
    pub func flowinfo(this) -> U32 {
        this.flowinfo
    }

    /// Sets the flow info.
    pub func set_flowinfo(mut this, flowinfo: U32) {
        this.flowinfo = flowinfo
    }

    /// Returns the scope ID associated with this socket address.
    ///
    /// This field corresponds to the `sin6_scope_id` field in C and
    /// is used for link-local addresses.
    pub func scope_id(this) -> U32 {
        this.scope_id
    }

    /// Sets the scope ID.
    pub func set_scope_id(mut this, scope_id: U32) {
        this.scope_id = scope_id
    }
}

// Behavior implementations for SocketAddrV6
impl Copy for SocketAddrV6 {}
impl Duplicate for SocketAddrV6 {
    func duplicate(this) -> SocketAddrV6 {
        SocketAddrV6 {
            ip: this.ip.duplicate(),
            port: this.port,
            flowinfo: this.flowinfo,
            scope_id: this.scope_id,
        }
    }
}

impl PartialEq for SocketAddrV6 {
    func eq(this, other: ref SocketAddrV6) -> Bool {
        this.ip == other.ip
            and this.port == other.port
            and this.flowinfo == other.flowinfo
            and this.scope_id == other.scope_id
    }
}

impl Eq for SocketAddrV6 {}

impl PartialOrd for SocketAddrV6 {
    func partial_cmp(this, other: ref SocketAddrV6) -> Maybe[Ordering] {
        Just(this.cmp(other))
    }
}

impl Ord for SocketAddrV6 {
    func cmp(this, other: ref SocketAddrV6) -> Ordering {
        let ip_ord = this.ip.cmp(ref other.ip)
        if ip_ord != Ordering::Equal {
            return ip_ord
        }

        if this.port < other.port { return Ordering::Less }
        if this.port > other.port { return Ordering::Greater }

        if this.flowinfo < other.flowinfo { return Ordering::Less }
        if this.flowinfo > other.flowinfo { return Ordering::Greater }

        if this.scope_id < other.scope_id { return Ordering::Less }
        if this.scope_id > other.scope_id { return Ordering::Greater }

        Ordering::Equal
    }
}

impl Hash for SocketAddrV6 {
    func hash(this, hasher: mut ref Hasher) {
        this.ip.hash(hasher)
        hasher.write_u16(this.port)
        hasher.write_u32(this.flowinfo)
        hasher.write_u32(this.scope_id)
    }
}

impl Display for SocketAddrV6 {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        f.write_str("[")
        this.ip.fmt(f)
        f.write_str("]:")
        f.write_str(this.port.to_string())
    }
}

impl Debug for SocketAddrV6 {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        Display::fmt(this, f)
    }
}

// =============================================================================
// SocketAddr - Either IPv4 or IPv6 Socket Address
// =============================================================================

/// An internet socket address, either IPv4 or IPv6.
///
/// # Examples
///
/// ```tml
/// let v4: SocketAddr = SocketAddr::V4(SocketAddrV4::new(Ipv4Addr::LOCALHOST, 80))
/// let v6: SocketAddr = SocketAddr::V6(SocketAddrV6::new(Ipv6Addr::LOCALHOST, 80, 0, 0))
///
/// assert_eq(v4.port(), 80)
/// assert_eq(v6.port(), 80)
/// ```
pub type SocketAddr = V4(SocketAddrV4) | V6(SocketAddrV6)

impl SocketAddr {
    /// Creates a new socket address from an IP address and port.
    pub func new(ip: IpAddr, port: U16) -> SocketAddr {
        when ip {
            IpAddr::V4(addr) => SocketAddr::V4(SocketAddrV4::new(addr, port)),
            IpAddr::V6(addr) => SocketAddr::V6(SocketAddrV6::new(addr, port, 0, 0)),
        }
    }

    /// Returns `true` if this is an IPv4 socket address.
    pub func is_ipv4(this) -> Bool {
        when this {
            V4(_) => true,
            V6(_) => false,
        }
    }

    /// Returns `true` if this is an IPv6 socket address.
    pub func is_ipv6(this) -> Bool {
        when this {
            V4(_) => false,
            V6(_) => true,
        }
    }

    /// Returns the IP address associated with this socket address.
    pub func ip(this) -> IpAddr {
        when this {
            V4(addr) => IpAddr::V4(addr.ip()),
            V6(addr) => IpAddr::V6(addr.ip()),
        }
    }

    /// Sets the IP address.
    pub func set_ip(mut this, ip: IpAddr) {
        when (mut this, ip) {
            (V4(mut addr), IpAddr::V4(new_ip)) => addr.set_ip(new_ip),
            (V6(mut addr), IpAddr::V6(new_ip)) => addr.set_ip(new_ip),
            _ => {
                // Type mismatch - convert the socket address
                when ip {
                    IpAddr::V4(new_ip) => {
                        let port = this.port()
                        this = SocketAddr::V4(SocketAddrV4::new(new_ip, port))
                    },
                    IpAddr::V6(new_ip) => {
                        let port = this.port()
                        this = SocketAddr::V6(SocketAddrV6::new(new_ip, port, 0, 0))
                    },
                }
            },
        }
    }

    /// Returns the port number associated with this socket address.
    pub func port(this) -> U16 {
        when this {
            V4(addr) => addr.port(),
            V6(addr) => addr.port(),
        }
    }

    /// Sets the port number.
    pub func set_port(mut this, port: U16) {
        when mut this {
            V4(mut addr) => addr.set_port(port),
            V6(mut addr) => addr.set_port(port),
        }
    }
}

// Behavior implementations for SocketAddr
impl Copy for SocketAddr {}
impl Duplicate for SocketAddr {
    func duplicate(this) -> SocketAddr {
        when this {
            V4(addr) => SocketAddr::V4(addr.duplicate()),
            V6(addr) => SocketAddr::V6(addr.duplicate()),
        }
    }
}

impl PartialEq for SocketAddr {
    func eq(this, other: ref SocketAddr) -> Bool {
        when (this, other) {
            (V4(a), V4(b)) => a == b,
            (V6(a), V6(b)) => a == b,
            _ => false,
        }
    }
}

impl Eq for SocketAddr {}

impl Hash for SocketAddr {
    func hash(this, hasher: mut ref Hasher) {
        when this {
            V4(addr) => {
                hasher.write_u8(4)
                addr.hash(hasher)
            },
            V6(addr) => {
                hasher.write_u8(6)
                addr.hash(hasher)
            },
        }
    }
}

impl Display for SocketAddr {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        when this {
            V4(addr) => addr.fmt(f),
            V6(addr) => addr.fmt(f),
        }
    }
}

impl Debug for SocketAddr {
    func fmt(this, f: mut ref Formatter) -> FormatResult {
        Display::fmt(this, f)
    }
}
