// Tests for ptr::ops â€” ptr_distance_mut, swap, replace
// NOTE: copy/copy_mut blocked by memmove codegen bug (struct vs ptr)
// NOTE: read_volatile/write_volatile/read_unaligned/write_unaligned blocked by unresolved intrinsics
use test::{assert, assert_eq}
use core::ptr::ops::{ptr_distance_mut, swap, replace}
use core::ptr::mut_ptr::RawMutPtr

@test
func test_ptr_distance_mut_i64() -> I32 {
    let a: RawMutPtr[I64] = RawMutPtr::from_addr(0x2000 as I64)
    let b: RawMutPtr[I64] = RawMutPtr::from_addr(0x2018 as I64)
    let dist: I64 = ptr_distance_mut(a, b)
    assert_eq(dist, 3 as I64, "ptr_distance_mut 24 bytes / 8 = 3")
    0
}

@test
func test_ptr_distance_mut_same() -> I32 {
    let a: RawMutPtr[I32] = RawMutPtr::from_addr(0x1000 as I64)
    let dist: I64 = ptr_distance_mut(a, a)
    assert_eq(dist, 0 as I64, "same address = 0 distance")
    0
}

@test
func test_swap_via_heap() -> I32 {
    let pa: *Unit = alloc(8)
    let pb: *Unit = alloc(8)
    let a: RawMutPtr[I64] = RawMutPtr::from_addr(pa as I64)
    let b: RawMutPtr[I64] = RawMutPtr::from_addr(pb as I64)
    a.write(10 as I64)
    b.write(20 as I64)
    swap(a, b)
    assert_eq(a.read(), 20 as I64, "after swap a should be 20")
    assert_eq(b.read(), 10 as I64, "after swap b should be 10")
    dealloc(pa)
    dealloc(pb)
    0
}

@test
func test_replace_via_heap() -> I32 {
    let pa: *Unit = alloc(8)
    let a: RawMutPtr[I64] = RawMutPtr::from_addr(pa as I64)
    a.write(42 as I64)
    let old: I64 = replace(a, 99 as I64)
    assert_eq(old, 42 as I64, "replace should return old value")
    assert_eq(a.read(), 99 as I64, "replace should write new value")
    dealloc(pa)
    0
}
