// Tests for core::sync - basic atomic operations
use test

@test
func test_atomic_store_load() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 42)
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 42, "atomic load should read stored value")
    dealloc(ptr)
    return 0
}

@test
func test_atomic_add_returns_old() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 10)
    let old: I32 = atomic_add(ptr, 5)
    assert_eq(old, 10, "atomic_add should return old value")
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 15, "value should be 15 after add")
    dealloc(ptr)
    return 0
}

@test
func test_atomic_sub_returns_old() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 20)
    let old: I32 = atomic_sub(ptr, 7)
    assert_eq(old, 20, "atomic_sub should return old value")
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 13, "value should be 13 after sub")
    dealloc(ptr)
    return 0
}

@test
func test_atomic_exchange() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 100)
    let old: I32 = atomic_exchange(ptr, 200)
    assert_eq(old, 100, "exchange should return old value")
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 200, "value should be 200 after exchange")
    dealloc(ptr)
    return 0
}

@test
func test_atomic_cas_success() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 50)
    let success: Bool = atomic_cas(ptr, 50, 99)
    assert(success, "CAS should succeed when expected matches")
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 99, "value should be 99 after successful CAS")
    dealloc(ptr)
    return 0
}

@test
func test_atomic_cas_fail() -> I32 {
    let ptr: *Unit = alloc(4)
    atomic_store(ptr, 50)
    let success: Bool = atomic_cas(ptr, 30, 99)
    assert(not success, "CAS should fail when expected doesn't match")
    let val: I32 = atomic_load(ptr)
    assert_eq(val, 50, "value should remain 50 after failed CAS")
    dealloc(ptr)
    return 0
}
