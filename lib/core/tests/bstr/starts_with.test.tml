// Tests for core::bstr - starts_with and ends_with
use test
use core::bstr
use core::slice::{Slice}

@test
func test_starts_with_match() -> I32 {
    // bytes = [72, 101, 108, 108, 111] ("Hello")
    // prefix = [72, 101] ("He")
    let ptr: *Unit = alloc(5)
    let u8_ptr: *U8 = ptr as *U8
    *u8_ptr = 72 as U8
    *(u8_ptr + 1) = 101 as U8
    *(u8_ptr + 2) = 108 as U8
    *(u8_ptr + 3) = 108 as U8
    *(u8_ptr + 4) = 111 as U8
    let bytes: Slice[U8] = Slice { data: ref *u8_ptr, len: 5 }

    let pptr: *Unit = alloc(2)
    let pu8: *U8 = pptr as *U8
    *pu8 = 72 as U8
    *(pu8 + 1) = 101 as U8
    let prefix: Slice[U8] = Slice { data: ref *pu8, len: 2 }

    assert(bstr::starts_with(bytes, prefix), "Hello starts with He")

    dealloc(ptr)
    dealloc(pptr)
    return 0
}

@test
func test_starts_with_no_match() -> I32 {
    // bytes = [72, 101] prefix = [88, 89]
    let ptr: *Unit = alloc(2)
    let u8_ptr: *U8 = ptr as *U8
    *u8_ptr = 72 as U8
    *(u8_ptr + 1) = 101 as U8
    let bytes: Slice[U8] = Slice { data: ref *u8_ptr, len: 2 }

    let pptr: *Unit = alloc(2)
    let pu8: *U8 = pptr as *U8
    *pu8 = 88 as U8
    *(pu8 + 1) = 89 as U8
    let prefix: Slice[U8] = Slice { data: ref *pu8, len: 2 }

    assert(bstr::starts_with(bytes, prefix) == false, "no match")

    dealloc(ptr)
    dealloc(pptr)
    return 0
}

@test
func test_ends_with_match() -> I32 {
    // bytes = [72, 101, 108, 108, 111] ("Hello")
    // suffix = [108, 111] ("lo")
    let ptr: *Unit = alloc(5)
    let u8_ptr: *U8 = ptr as *U8
    *u8_ptr = 72 as U8
    *(u8_ptr + 1) = 101 as U8
    *(u8_ptr + 2) = 108 as U8
    *(u8_ptr + 3) = 108 as U8
    *(u8_ptr + 4) = 111 as U8
    let bytes: Slice[U8] = Slice { data: ref *u8_ptr, len: 5 }

    let sptr: *Unit = alloc(2)
    let su8: *U8 = sptr as *U8
    *su8 = 108 as U8
    *(su8 + 1) = 111 as U8
    let suffix: Slice[U8] = Slice { data: ref *su8, len: 2 }

    assert(bstr::ends_with(bytes, suffix), "Hello ends with lo")

    dealloc(ptr)
    dealloc(sptr)
    return 0
}
