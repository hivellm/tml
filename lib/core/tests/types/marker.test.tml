// Tests for marker types (PhantomPinned, PhantomData)
use test

use core::marker::PhantomPinned
use core::marker::PhantomData

// A type that should not be moved after pinning
type SelfRefStruct {
    value: I64,
    _pinned: PhantomPinned
}

impl SelfRefStruct {
    pub func value(this) -> I64 {
        return this.value
    }
}

impl Display for SelfRefStruct {
    pub func to_string(this) -> Str {
        return "SelfRefStruct"
    }
}

impl Debug for SelfRefStruct {
    pub func debug_string(this) -> Str {
        let val: I64 = this.value
        return "SelfRefStruct(value=" + val.to_string() + ")"
    }
}

@test
func test_phantom_pinned_basic() -> I32 {
    // PhantomPinned can be created and used in structs
    let pinned: PhantomPinned = PhantomPinned {}

    // Can also use new()
    let pinned2: PhantomPinned = PhantomPinned::new()

    // Or default()
    let pinned3: PhantomPinned = PhantomPinned::default()

    return 0
}

@test
func test_phantom_pinned_in_struct() -> I32 {
    // PhantomPinned can be used as a field in structs
    let s: SelfRefStruct = SelfRefStruct {
        value: 42,
        _pinned: PhantomPinned {}
    }

    assert_eq(s.value(), 42, "value should be 42")

    return 0
}

@test
func test_phantom_pinned_duplicate() -> I32 {
    let pinned: PhantomPinned = PhantomPinned::new()
    let pinned2: PhantomPinned = pinned.duplicate()

    // Both should exist (no-op since PhantomPinned has no data)
    return 0
}

@test
func test_phantom_pinned_to_string() -> I32 {
    let pinned: PhantomPinned = PhantomPinned::new()
    assert(pinned.to_string() == "PhantomPinned", "Display should be PhantomPinned")
    assert(pinned.debug_string() == "PhantomPinned", "Debug should be PhantomPinned")
    return 0
}

// ============================================================================
// PhantomData Tests
// ============================================================================

type FileHandle {
    id: I64,
    _phantom: PhantomData[I32],
}

@test
func test_phantom_data_new() -> I32 {
    let pd: PhantomData[I32] = PhantomData::new()
    return 0
}

@test
func test_phantom_data_default() -> I32 {
    let pd: PhantomData[I64] = PhantomData::default()
    return 0
}

@test
func test_phantom_data_duplicate() -> I32 {
    let pd1: PhantomData[Bool] = PhantomData::new()
    let pd2: PhantomData[Bool] = pd1.duplicate()
    return 0
}

@test
func test_phantom_data_in_struct() -> I32 {
    let handle: FileHandle = FileHandle {
        id: 42,
        _phantom: PhantomData::new(),
    }
    assert(handle.id == 42 as I64, "id should be 42")
    return 0
}

