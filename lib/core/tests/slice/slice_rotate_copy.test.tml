// Tests for MutSlice rotate_left, rotate_right, copy_from_slice, and Slice split_at
use test::{assert, assert_eq}
use core::slice::{Slice, MutSlice}

@test
func test_rotate_left() -> I32 {
    let ptr: *Unit = alloc(20)
    atomic_store(ptr, 1)
    atomic_store(ptr_offset(ptr, 1), 2)
    atomic_store(ptr_offset(ptr, 2), 3)
    atomic_store(ptr_offset(ptr, 3), 4)
    atomic_store(ptr_offset(ptr, 4), 5)

    let mut s: MutSlice[I32] = MutSlice { data: ptr, len: 5 }
    s.rotate_left(2)

    let check: Slice[I32] = Slice { data: ptr, len: 5 }
    assert_eq(*check.get(0).unwrap(), 3, "rotate_left [0] = 3")
    assert_eq(*check.get(1).unwrap(), 4, "rotate_left [1] = 4")
    assert_eq(*check.get(2).unwrap(), 5, "rotate_left [2] = 5")
    assert_eq(*check.get(3).unwrap(), 1, "rotate_left [3] = 1")
    assert_eq(*check.get(4).unwrap(), 2, "rotate_left [4] = 2")

    dealloc(ptr)
    return 0
}

@test
func test_rotate_right() -> I32 {
    let ptr: *Unit = alloc(20)
    atomic_store(ptr, 1)
    atomic_store(ptr_offset(ptr, 1), 2)
    atomic_store(ptr_offset(ptr, 2), 3)
    atomic_store(ptr_offset(ptr, 3), 4)
    atomic_store(ptr_offset(ptr, 4), 5)

    let mut s: MutSlice[I32] = MutSlice { data: ptr, len: 5 }
    s.rotate_right(2)

    let check: Slice[I32] = Slice { data: ptr, len: 5 }
    assert_eq(*check.get(0).unwrap(), 4, "rotate_right [0] = 4")
    assert_eq(*check.get(1).unwrap(), 5, "rotate_right [1] = 5")
    assert_eq(*check.get(2).unwrap(), 1, "rotate_right [2] = 1")
    assert_eq(*check.get(3).unwrap(), 2, "rotate_right [3] = 2")
    assert_eq(*check.get(4).unwrap(), 3, "rotate_right [4] = 3")

    dealloc(ptr)
    return 0
}

@test
func test_split_at() -> I32 {
    let ptr: *Unit = alloc(20)
    atomic_store(ptr, 10)
    atomic_store(ptr_offset(ptr, 1), 20)
    atomic_store(ptr_offset(ptr, 2), 30)
    atomic_store(ptr_offset(ptr, 3), 40)
    atomic_store(ptr_offset(ptr, 4), 50)

    let s: Slice[I32] = Slice { data: ptr, len: 5 }
    let pair: (Slice[I32], Slice[I32]) = s.split_at(2)
    let left: Slice[I32] = pair.0
    let right: Slice[I32] = pair.1

    assert_eq(left.len(), 2, "left len")
    assert_eq(right.len(), 3, "right len")
    assert_eq(*left.get(0).unwrap(), 10, "left[0] = 10")
    assert_eq(*left.get(1).unwrap(), 20, "left[1] = 20")
    assert_eq(*right.get(0).unwrap(), 30, "right[0] = 30")
    assert_eq(*right.get(2).unwrap(), 50, "right[2] = 50")

    dealloc(ptr)
    return 0
}

@test
func test_copy_from_slice() -> I32 {
    let src_ptr: *Unit = alloc(12)
    atomic_store(src_ptr, 7)
    atomic_store(ptr_offset(src_ptr, 1), 8)
    atomic_store(ptr_offset(src_ptr, 2), 9)

    let dst_ptr: *Unit = alloc(12)
    atomic_store(dst_ptr, 0)
    atomic_store(ptr_offset(dst_ptr, 1), 0)
    atomic_store(ptr_offset(dst_ptr, 2), 0)

    let src: Slice[I32] = Slice { data: src_ptr, len: 3 }
    let mut dst: MutSlice[I32] = MutSlice { data: dst_ptr, len: 3 }
    dst.copy_from_slice(src)

    let check: Slice[I32] = Slice { data: dst_ptr, len: 3 }
    assert_eq(*check.get(0).unwrap(), 7, "copy[0] = 7")
    assert_eq(*check.get(1).unwrap(), 8, "copy[1] = 8")
    assert_eq(*check.get(2).unwrap(), 9, "copy[2] = 9")

    dealloc(src_ptr)
    dealloc(dst_ptr)
    return 0
}
