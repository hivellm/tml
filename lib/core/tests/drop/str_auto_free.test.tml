// Tests for heap string auto-free (Phase 5 validation)
//
// Verifies that heap-allocated strings (from interpolation, concat,
// function returns) are properly freed via tml_str_free, and that
// string literals (global constants) are NOT freed.

use test::{assert, assert_eq}

// ============================================================================
// Test 1: Interpolated string — heap allocated, should be freed
// ============================================================================

@test
func test_interpolated_string_freed() -> I32 {
    let name: Str = "world"
    {
        let greeting: Str = "hello {name}"
        assert_eq(greeting, "hello world", "interpolation works")
        // greeting is heap-allocated — tml_str_free called at scope exit
    }
    // If we get here, no crash from freeing
    assert(true, "interpolated string freed without crash")
    return 0
}

// ============================================================================
// Test 2: String concat — heap allocated
// ============================================================================

@test
func test_string_concat_freed() -> I32 {
    let a: Str = "foo"
    let b: Str = "bar"
    {
        let c: Str = a + b
        assert_eq(c, "foobar", "concat works")
        // c is heap-allocated (BinaryExpr) — freed at scope exit
    }
    assert(true, "concat string freed without crash")
    return 0
}

// ============================================================================
// Test 3: Multiple concats in loop — stress heap string cleanup
// ============================================================================

@test
func test_concat_loop_no_leak() -> I32 {
    var i: I32 = 0
    loop (i < 50) {
        let s: Str = "iter" + "_done"
        assert_eq(s, "iter_done", "concat in loop works")
        // s freed at end of loop body each iteration
        i = i + 1
    }
    assert_eq(i, 50, "completed 50 iterations of concat")
    return 0
}
