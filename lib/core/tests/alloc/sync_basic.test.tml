// Tests for core::alloc::sync - Sync[T] atomic reference counting
use test
use core::alloc::sync::{Sync}

@test
func test_sync_new() -> I32 {
    let s: Sync[I32] = Sync::new(42 as I32)
    assert_eq(s.get(), 42 as I32, "Sync::new stores value")
    assert_eq(s.strong_count(), 1 as I32, "initial count is 1")
    return 0
}

@test
func test_sync_is_unique() -> I32 {
    let s: Sync[I32] = Sync::new(10 as I32)
    assert(s.is_unique(), "single ref should be unique")
    return 0
}

@test
func test_sync_duplicate() -> I32 {
    let s1: Sync[I32] = Sync::new(88 as I32)
    let s2: Sync[I32] = s1.duplicate()
    assert_eq(s1.strong_count(), 2 as I32, "count after duplicate is 2")
    assert_eq(s2.get(), 88 as I32, "duplicate shares same value")
    assert(not s1.is_unique(), "no longer unique after duplicate")
    return 0
}
