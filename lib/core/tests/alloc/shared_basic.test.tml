// Tests for core::alloc::shared - Shared[T] reference counting
use test
use core::alloc::shared::{Shared}

@test
func test_shared_new() -> I32 {
    let s: Shared[I32] = Shared::new(42 as I32)
    assert_eq(s.get(), 42 as I32, "Shared::new stores value")
    assert_eq(s.strong_count(), 1 as I32, "initial count is 1")
    return 0
}

@test
func test_shared_is_unique() -> I32 {
    let s: Shared[I32] = Shared::new(10 as I32)
    assert(s.is_unique(), "single ref should be unique")
    return 0
}

@test
func test_shared_duplicate() -> I32 {
    let s1: Shared[I32] = Shared::new(77 as I32)
    let s2: Shared[I32] = s1.duplicate()
    assert_eq(s1.strong_count(), 2 as I32, "count after duplicate is 2")
    assert_eq(s2.get(), 77 as I32, "duplicate shares same value")
    assert(not s1.is_unique(), "no longer unique after duplicate")
    return 0
}
