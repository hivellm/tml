// Tests for type (struct) definitions - creation, field access, methods
use test

// =============================================================================
// Basic type definition and field access
// =============================================================================

type Point {
    x: I32,
    y: I32
}

@test
func test_type_create() -> I32 {
    let p: Point = Point { x: 10, y: 20 }
    assert_eq(p.x, 10, "point x should be 10")
    assert_eq(p.y, 20, "point y should be 20")
    return 0
}

@test
func test_type_zero_fields() -> I32 {
    let p: Point = Point { x: 0, y: 0 }
    assert_eq(p.x, 0, "zero point x")
    assert_eq(p.y, 0, "zero point y")
    return 0
}

@test
func test_type_negative_fields() -> I32 {
    let p: Point = Point { x: -5, y: -10 }
    assert_eq(p.x, -5, "negative x")
    assert_eq(p.y, -10, "negative y")
    return 0
}

// =============================================================================
// Type with methods (impl)
// =============================================================================

type Rectangle {
    width: I32,
    height: I32
}

impl Rectangle {
    func area(this) -> I32 {
        return this.width * this.height
    }

    func perimeter(this) -> I32 {
        return 2 * (this.width + this.height)
    }

    func is_square(this) -> Bool {
        return this.width == this.height
    }
}

@test
func test_type_method_area() -> I32 {
    let r: Rectangle = Rectangle { width: 5, height: 3 }
    assert_eq(r.area(), 15, "5x3 area should be 15")
    return 0
}

@test
func test_type_method_perimeter() -> I32 {
    let r: Rectangle = Rectangle { width: 5, height: 3 }
    assert_eq(r.perimeter(), 16, "5x3 perimeter should be 16")
    return 0
}

@test
func test_type_method_is_square() -> I32 {
    let r1: Rectangle = Rectangle { width: 4, height: 4 }
    let r2: Rectangle = Rectangle { width: 4, height: 5 }
    assert(r1.is_square(), "4x4 should be square")
    assert(not r2.is_square(), "4x5 should not be square")
    return 0
}

// =============================================================================
// Type passed to functions
// =============================================================================

func distance_squared(p1: Point, p2: Point) -> I32 {
    let dx: I32 = p2.x - p1.x
    let dy: I32 = p2.y - p1.y
    return dx * dx + dy * dy
}

@test
func test_type_as_param() -> I32 {
    let p1: Point = Point { x: 0, y: 0 }
    let p2: Point = Point { x: 3, y: 4 }
    assert_eq(distance_squared(p1, p2), 25, "distance_squared should be 25")
    return 0
}

// =============================================================================
// Type returned from functions
// =============================================================================

func make_point(x: I32, y: I32) -> Point {
    return Point { x: x, y: y }
}

@test
func test_type_return() -> I32 {
    let p: Point = make_point(7, 11)
    assert_eq(p.x, 7, "returned point x should be 7")
    assert_eq(p.y, 11, "returned point y should be 11")
    return 0
}

// =============================================================================
// Mutable type fields
// =============================================================================

@test
func test_type_mutable() -> I32 {
    var p: Point = Point { x: 1, y: 2 }
    p.x = 10
    p.y = 20
    assert_eq(p.x, 10, "mutated x should be 10")
    assert_eq(p.y, 20, "mutated y should be 20")
    return 0
}
