//! Tests for test::coverage module â€” coverage tracking functions.
//! NOTE: These tests use relative counts instead of absolute values
//! because in --coverage mode, the compiler instruments all function
//! calls with tml_cover_func, so counts may be non-zero after reset.

use test::{assert, assert_eq, assert_true, assert_false, assert_gte}
use test::coverage

@test
func test_reset_and_count() -> I32 {
    coverage::reset_coverage()
    let count: I32 = coverage::get_covered_func_count()
    // In coverage mode, instrumented calls after reset may add entries.
    // Just verify count is non-negative (reset didn't corrupt state).
    assert_gte(count, 0, "after reset, func count should be >= 0")
    return 0
}

@test
func test_cover_func_basic() -> I32 {
    coverage::reset_coverage()
    let baseline: I32 = coverage::get_covered_func_count()
    coverage::cover_func("my_function_unique_test")
    let count: I32 = coverage::get_covered_func_count()
    assert(count > baseline, "covering a function should increase count")
    return 0
}

@test
func test_cover_multiple_funcs() -> I32 {
    coverage::reset_coverage()
    let baseline: I32 = coverage::get_covered_func_count()
    coverage::cover_func("func_a_unique")
    coverage::cover_func("func_b_unique")
    coverage::cover_func("func_c_unique")
    let count: I32 = coverage::get_covered_func_count()
    assert(count >= (baseline + 3), "covering 3 functions should increase count by at least 3")
    return 0
}

@test
func test_is_func_covered() -> I32 {
    coverage::reset_coverage()
    let before: Bool = coverage::is_func_covered("target_fn_unique")
    assert_false(before, "function should not be covered before marking")
    coverage::cover_func("target_fn_unique")
    let after: Bool = coverage::is_func_covered("target_fn_unique")
    assert_true(after, "function should be covered after marking")
    return 0
}

@test
func test_cover_line() -> I32 {
    coverage::reset_coverage()
    coverage::cover_line("test.tml", 10)
    coverage::cover_line("test.tml", 20)
    let count: I32 = coverage::get_covered_line_count()
    assert_eq(count, 2, "after covering 2 lines, count should be 2")
    return 0
}

@test
func test_cover_branch() -> I32 {
    coverage::reset_coverage()
    coverage::cover_branch("test.tml", 10, 0)
    coverage::cover_branch("test.tml", 10, 1)
    let count: I32 = coverage::get_covered_branch_count()
    assert_eq(count, 2, "after covering 2 branches, count should be 2")
    return 0
}

@test
func test_assert_func_covered_passes() -> I32 {
    coverage::reset_coverage()
    coverage::cover_func("assert_target_unique")
    coverage::assert_func_covered("assert_target_unique", "should pass")
    return 0
}

@test
func test_get_coverage_percent() -> I32 {
    coverage::reset_coverage()
    let pct: I32 = coverage::get_coverage_percent()
    assert_gte(pct, 0, "coverage percent should be >= 0")
    return 0
}
