use test
use std::collections

// Collection Operations Tests (List, HashMap, Buffer)

@test
func test_list() -> I32 {
    // Create list with initial capacity 4
    let list: List = list_create(4)

    // Push elements
    list_push(list, 10)
    list_push(list, 20)
    list_push(list, 30)

    // Test length
    assert_eq(list_len(list), 3, "list_len should be 3")

    // Test get
    assert_eq(list_get(list, 0), 10, "list_get(0) should be 10")
    assert_eq(list_get(list, 1), 20, "list_get(1) should be 20")
    assert_eq(list_get(list, 2), 30, "list_get(2) should be 30")

    // Test set
    list_set(list, 1, 25)
    assert_eq(list_get(list, 1), 25, "list_get(1) should be 25 after set")

    // Test pop
    let popped: I32 = list_pop(list)
    assert_eq(popped, 30, "list_pop should return 30")
    assert_eq(list_len(list), 2, "list_len should be 2 after pop")

    // Test is_empty
    let is_empty1: Bool = list_is_empty(list)
    assert_eq(is_empty1, false, "list should not be empty")

    // Test clear
    list_clear(list)
    let is_empty2: Bool = list_is_empty(list)
    assert_eq(is_empty2, true, "list should be empty after clear")

    // Test capacity
    let cap: I32 = list_capacity(list)
    assert(cap >= 4, "capacity should be at least 4")

    // Clean up
    list_destroy(list)

    return 0
}

@test
func test_hashmap() {
    // Create hashmap with capacity 16
    let map: HashMap = hashmap_create(16)

    // Set values
    hashmap_set(map, 1, 100)
    hashmap_set(map, 2, 200)
    hashmap_set(map, 3, 300)

    // Test len
    assert_eq(hashmap_len(map), 3, "hashmap_len should be 3")

    // Test has
    let has1: Bool = hashmap_has(map, 1)
    assert_eq(has1, true, "hashmap should have key 1")
    let has2: Bool = hashmap_has(map, 2)
    assert_eq(has2, true, "hashmap should have key 2")
    let has99: Bool = hashmap_has(map, 99)
    assert_eq(has99, false, "hashmap should not have key 99")

    // Test get
    assert_eq(hashmap_get(map, 1), 100, "hashmap_get(1) should be 100")
    assert_eq(hashmap_get(map, 2), 200, "hashmap_get(2) should be 200")
    assert_eq(hashmap_get(map, 3), 300, "hashmap_get(3) should be 300")

    // Test overwrite
    hashmap_set(map, 2, 250)
    assert_eq(hashmap_get(map, 2), 250, "hashmap_get(2) should be 250 after overwrite")
    assert_eq(hashmap_len(map), 3, "hashmap_len should still be 3 after overwrite")

    // Test remove
    let removed: Bool = hashmap_remove(map, 1)
    assert_eq(removed, true, "hashmap_remove(1) should return true")
    let has1_after: Bool = hashmap_has(map, 1)
    assert_eq(has1_after, false, "hashmap should not have key 1 after remove")
    assert_eq(hashmap_len(map), 2, "hashmap_len should be 2 after remove")

    // Test clear
    hashmap_clear(map)
    assert_eq(hashmap_len(map), 0, "hashmap_len should be 0 after clear")

    // Clean up
    hashmap_destroy(map)
}

@test
func test_buffer() -> I32 {
    // Create buffer with capacity 32
    let buf: Buffer = buffer_create(32)

    // Test initial state
    assert_eq(buffer_len(buf), 0, "buffer_len should be 0 initially")
    assert_eq(buffer_capacity(buf), 32, "buffer_capacity should be 32")

    // Write bytes
    buffer_write_byte(buf, 65)  // 'A'
    buffer_write_byte(buf, 66)  // 'B'
    buffer_write_byte(buf, 67)  // 'C'

    assert_eq(buffer_len(buf), 3, "buffer_len should be 3 after writes")

    // Read bytes
    let b1: I32 = buffer_read_byte(buf)
    let b2: I32 = buffer_read_byte(buf)
    let b3: I32 = buffer_read_byte(buf)

    assert_eq(b1, 65, "first byte should be 65")
    assert_eq(b2, 66, "second byte should be 66")
    assert_eq(b3, 67, "third byte should be 67")

    // Test remaining
    assert_eq(buffer_remaining(buf), 0, "buffer_remaining should be 0")

    // Test reset_read
    buffer_reset_read(buf)
    assert_eq(buffer_remaining(buf), 3, "buffer_remaining should be 3 after reset")

    // Write and read i32
    buffer_clear(buf)
    buffer_write_i32(buf, 12345678)

    assert_eq(buffer_len(buf), 4, "buffer_len should be 4 after write_i32")

    let val: I32 = buffer_read_i32(buf)
    assert_eq(val, 12345678, "buffer_read_i32 should return 12345678")

    // Clean up
    buffer_destroy(buf)

    return 0
}
