use test

// Memory Runtime Tests
// Tests all functions from runtime/mem.c
// Note: Simplified to avoid Bool return type codegen issues

@test
func test_mem_alloc_basic() -> I32 {
    let size: I64 = 64
    let ptr: *Unit = mem_alloc(size)
    // Just verify alloc doesn't crash
    mem_free(ptr)
    return 0
}

@test
func test_mem_alloc_zeroed() -> I32 {
    let size: I64 = 32
    let ptr: *Unit = mem_alloc_zeroed(size)
    // Zeroed memory allocated successfully
    mem_free(ptr)
    return 0
}

@test
func test_mem_realloc() -> I32 {
    let size1: I64 = 32
    let size2: I64 = 64
    let ptr1: *Unit = mem_alloc(size1)
    let ptr2: *Unit = mem_realloc(ptr1, size2)
    // Realloc should work
    mem_free(ptr2)
    return 0
}

@test
func test_mem_set_and_compare() -> I32 {
    let size: I64 = 16
    let ptr1: *Unit = mem_alloc(size)
    let ptr2: *Unit = mem_alloc(size)

    // Set both to same value
    mem_set(ptr1, 42, size)
    mem_set(ptr2, 42, size)

    // They should be equal (compare returns 0 for equal)
    let cmp: I32 = mem_compare(ptr1, ptr2, size)
    assert(cmp == 0, "same memory should compare equal")

    mem_free(ptr1)
    mem_free(ptr2)
    return 0
}

@test
func test_mem_set_different() -> I32 {
    let size: I64 = 16
    let ptr1: *Unit = mem_alloc(size)
    let ptr2: *Unit = mem_alloc(size)

    // Set to different values
    mem_set(ptr1, 10, size)
    mem_set(ptr2, 20, size)

    // They should NOT be equal
    let cmp: I32 = mem_compare(ptr1, ptr2, size)
    assert(cmp != 0, "different memory should not compare equal")

    mem_free(ptr1)
    mem_free(ptr2)
    return 0
}

@test
func test_mem_zero() -> I32 {
    let size: I64 = 32
    let ptr: *Unit = mem_alloc(size)

    // Set to non-zero first
    mem_set(ptr, 255, size)

    // Zero it
    mem_zero(ptr, size)

    // Compare with fresh zeroed memory
    let zeroed: *Unit = mem_alloc_zeroed(size)
    let cmp: I32 = mem_compare(ptr, zeroed, size)
    assert(cmp == 0, "mem_zero should zero memory")

    mem_free(ptr)
    mem_free(zeroed)
    return 0
}

@test
func test_mem_copy() -> I32 {
    let size: I64 = 16
    let src: *Unit = mem_alloc(size)
    let dest: *Unit = mem_alloc(size)

    // Set source to pattern
    mem_set(src, 123, size)
    mem_zero(dest, size)

    // Copy
    mem_copy(dest, src, size)

    // Should be equal now (compare returns 0 for equal)
    let cmp: I32 = mem_compare(src, dest, size)
    assert(cmp == 0, "mem_copy should copy content")

    mem_free(src)
    mem_free(dest)
    return 0
}

@test
func test_mem_move() -> I32 {
    let size: I64 = 32
    let ptr: *Unit = mem_alloc(size)

    // Set to pattern
    mem_set(ptr, 77, size)

    // mem_move can handle overlapping regions
    // Just verify it doesn't crash
    mem_move(ptr, ptr, 16)

    mem_free(ptr)
    return 0
}
