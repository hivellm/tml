// Test 16: Memory allocation and manipulation
func main() {
    // Allocate memory for 4 integers (16 bytes)
    let mem = alloc(16)

    // Write values to memory
    write_i32(mem, 10)
    write_i32(ptr_offset(mem, 1), 20)
    write_i32(ptr_offset(mem, 2), 30)
    write_i32(ptr_offset(mem, 3), 40)

    // Read values back
    println(read_i32(mem))                 // 10
    println(read_i32(ptr_offset(mem, 1)))  // 20
    println(read_i32(ptr_offset(mem, 2)))  // 30
    println(read_i32(ptr_offset(mem, 3)))  // 40

    // Sum array manually
    let v0 = read_i32(mem)
    let v1 = read_i32(ptr_offset(mem, 1))
    let v2 = read_i32(ptr_offset(mem, 2))
    let v3 = read_i32(ptr_offset(mem, 3))
    let sum = v0 + v1 + v2 + v3
    println(sum)  // 100

    // Free memory
    dealloc(mem)

    // Dynamic array example: compute factorial via memoization
    let cache = alloc(40)  // 10 integers
    write_i32(cache, 1)    // fact(0) = 1
    write_i32(ptr_offset(cache, 1), 1)  // fact(1) = 1

    // Compute fact(2) through fact(9)
    let i = 2
    loop {
        if i >= 10 {
            break
        }
        let prev = read_i32(ptr_offset(cache, i - 1))
        write_i32(ptr_offset(cache, i), prev * i)
        i = i + 1
    }

    // Print factorial results
    println(read_i32(ptr_offset(cache, 5)))  // 120 (5!)
    println(read_i32(ptr_offset(cache, 6)))  // 720 (6!)

    dealloc(cache)
}
