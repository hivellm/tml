// Tests for core::mem module
// Note: The mem module provides low-level memory operations.
// See packages/core/src/mem.tml for the definitions.
use test

// ============================================================================
// Memory Operation Pattern Tests (Pure TML)
// ============================================================================

@test
func test_swap_via_function() {
    // Testing the swap pattern using a helper function
    let result: I32 = do_swap(10, 20)
    assert_eq(result, 30)  // Sum verifies both values were accessed
}

func do_swap(a: I32, b: I32) -> I32 {
    // Simulating swap logic - in real swap, values would be exchanged
    let temp: I32 = a
    // Return sum to verify both values
    return temp + b
}

@test
func test_replace_via_function() {
    // Testing the replace pattern using a return value
    let result: I32 = do_replace(42, 100)
    assert_eq(result, 42)  // Returns old value
}

func do_replace(old_val: I32, new_val: I32) -> I32 {
    // Simulating replace - return old value
    return old_val
}

@test
func test_take_via_function() {
    // Testing the take pattern - takes value, leaves default
    let result: I32 = do_take(42)
    assert_eq(result, 42)  // Returns taken value
}

func do_take(val: I32) -> I32 {
    // Simulating take - return value, caller would get default
    return val
}

@test
func test_drop_pattern() {
    // Testing explicit drop by letting value go out of scope
    let value: I32 = 42
    // Value is dropped when it goes out of scope
    assert(true)
}

// ============================================================================
// ManuallyDrop Pattern Test
// ============================================================================

type ManuallyDropI32 {
    value: I32
}

impl ManuallyDropI32 {
    pub func new(v: I32) -> ManuallyDropI32 {
        return ManuallyDropI32 { value: v }
    }

    pub func into_inner(this) -> I32 {
        return this.value
    }
}

@test
func test_manually_drop_pattern() {
    let md: ManuallyDropI32 = ManuallyDropI32::new(42)
    let extracted: I32 = md.into_inner()
    assert_eq(extracted, 42)
}

// ============================================================================
// TODO: Tests below require core::mem module functions to be loadable
// ============================================================================

// The core::mem module defines:
// - size_of[T]() -> I64: returns type size in bytes
// - align_of[T]() -> I64: returns type alignment
// - swap[T](a, b): swaps values at two locations
// - replace[T](dest, src): replaces and returns old value
// - take[T: Default](dest): takes value, leaves default
// - forget[T](value): leaks without running destructor
// - ManuallyDrop[T]: prevents automatic drop
// - MaybeUninit[T]: possibly uninitialized memory

// These require the compiler to:
// 1. Support lowlevel intrinsics: sizeof_type[T](), alignof_type[T]()
// 2. Support generic functions with mutable references
// 3. Support Drop behavior for cleanup
