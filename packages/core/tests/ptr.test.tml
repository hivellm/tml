// Tests for core::ptr module

use core::ptr::{RawPtr, RawMutPtr, NonNull, ptr_distance, copy_nonoverlapping, copy, write_bytes}

// ============================================================================
// RawPtr Basic Tests
// ============================================================================

@test
func test_raw_ptr_null() {
    let ptr: RawPtr[I32] = RawPtr::null()
    assert(ptr.is_null())
}

@test
func test_raw_ptr_from_addr() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(1234)
    assert(ptr.is_null() == false)
    assert_eq(ptr.addr(), 1234)
}

@test
func test_raw_ptr_null_addr() {
    let ptr: RawPtr[I32] = RawPtr::null()
    assert_eq(ptr.addr(), 0)
}

@test
func test_raw_ptr_cast() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(1000)
    let casted: RawPtr[U8] = ptr.cast[U8]()
    assert_eq(casted.addr(), 1000)
}

@test
func test_raw_ptr_offset() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(1000)
    let offset_ptr: RawPtr[I32] = ptr.offset(2)
    // I32 is 4 bytes, so offset by 2 = 8 bytes
    assert_eq(offset_ptr.addr(), 1008)
}

@test
func test_raw_ptr_add() {
    let ptr: RawPtr[I64] = RawPtr::from_addr(100)
    let added: RawPtr[I64] = ptr.add(3)
    // I64 is 8 bytes, so add 3 = 24 bytes
    assert_eq(added.addr(), 124)
}

@test
func test_raw_ptr_sub() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(100)
    let subbed: RawPtr[I32] = ptr.sub(2)
    // I32 is 4 bytes, so sub 2 = 8 bytes
    assert_eq(subbed.addr(), 92)
}

// ============================================================================
// RawMutPtr Basic Tests
// ============================================================================

@test
func test_raw_mut_ptr_null() {
    let ptr: RawMutPtr[I32] = RawMutPtr::null()
    assert(ptr.is_null())
}

@test
func test_raw_mut_ptr_from_addr() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(5678)
    assert(ptr.is_null() == false)
    assert_eq(ptr.addr(), 5678)
}

@test
func test_raw_mut_ptr_cast() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(2000)
    let casted: RawMutPtr[U16] = ptr.cast[U16]()
    assert_eq(casted.addr(), 2000)
}

@test
func test_raw_mut_ptr_as_const() {
    let mut_ptr: RawMutPtr[I32] = RawMutPtr::from_addr(3000)
    let const_ptr: RawPtr[I32] = mut_ptr.as_const()
    assert_eq(const_ptr.addr(), 3000)
}

@test
func test_raw_mut_ptr_offset() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(500)
    let offset_ptr: RawMutPtr[I32] = ptr.offset(5)
    assert_eq(offset_ptr.addr(), 520)  // 500 + 5*4
}

// ============================================================================
// NonNull Tests
// ============================================================================

@test
func test_nonnull_new_valid() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(1000)
    let nn: Maybe[NonNull[I32]] = NonNull::new(ptr)
    assert(nn.is_just())
}

@test
func test_nonnull_new_null() {
    let ptr: RawMutPtr[I32] = RawMutPtr::null()
    let nn: Maybe[NonNull[I32]] = NonNull::new(ptr)
    assert(nn.is_nothing())
}

@test
func test_nonnull_dangling() {
    let nn: NonNull[I32] = NonNull::dangling()
    // Dangling pointer has alignment as address (4 for I32)
    assert_eq(nn.as_ptr().addr(), 4)
}

@test
func test_nonnull_as_ptr() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(2000)
    let nn: NonNull[I32] = NonNull::new_unchecked(ptr)
    assert_eq(nn.as_ptr().addr(), 2000)
}

@test
func test_nonnull_as_const_ptr() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(3000)
    let nn: NonNull[I32] = NonNull::new_unchecked(ptr)
    let const_ptr: RawPtr[I32] = nn.as_const_ptr()
    assert_eq(const_ptr.addr(), 3000)
}

@test
func test_nonnull_cast() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(4000)
    let nn: NonNull[I32] = NonNull::new_unchecked(ptr)
    let casted: NonNull[U8] = nn.cast[U8]()
    assert_eq(casted.as_ptr().addr(), 4000)
}

// ============================================================================
// Pointer Distance Tests
// ============================================================================

@test
func test_ptr_distance_positive() {
    let from: RawPtr[I32] = RawPtr::from_addr(100)
    let to: RawPtr[I32] = RawPtr::from_addr(120)
    let dist: I64 = ptr_distance(from, to)
    assert_eq(dist, 5)  // (120 - 100) / 4 = 5 elements
}

@test
func test_ptr_distance_negative() {
    let from: RawPtr[I32] = RawPtr::from_addr(120)
    let to: RawPtr[I32] = RawPtr::from_addr(100)
    let dist: I64 = ptr_distance(from, to)
    assert_eq(dist, -5)
}

@test
func test_ptr_distance_zero() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(100)
    let dist: I64 = ptr_distance(ptr, ptr)
    assert_eq(dist, 0)
}

@test
func test_ptr_distance_i64() {
    let from: RawPtr[I64] = RawPtr::from_addr(0)
    let to: RawPtr[I64] = RawPtr::from_addr(80)
    let dist: I64 = ptr_distance(from, to)
    assert_eq(dist, 10)  // 80 / 8 = 10 elements
}

// ============================================================================
// Pointer Comparison Tests
// ============================================================================

@test
func test_raw_ptr_eq() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1000)
    let p2: RawPtr[I32] = RawPtr::from_addr(1000)
    assert(p1.eq(ref p2))
}

@test
func test_raw_ptr_ne() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1000)
    let p2: RawPtr[I32] = RawPtr::from_addr(2000)
    assert(p1.eq(ref p2) == false)
}

@test
func test_raw_ptr_cmp_less() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1000)
    let p2: RawPtr[I32] = RawPtr::from_addr(2000)
    when p1.cmp(ref p2) {
        Less => assert(true),
        _ => assert(false)
    }
}

@test
func test_raw_ptr_cmp_greater() {
    let p1: RawPtr[I32] = RawPtr::from_addr(2000)
    let p2: RawPtr[I32] = RawPtr::from_addr(1000)
    when p1.cmp(ref p2) {
        Greater => assert(true),
        _ => assert(false)
    }
}

@test
func test_raw_ptr_cmp_equal() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1000)
    let p2: RawPtr[I32] = RawPtr::from_addr(1000)
    when p1.cmp(ref p2) {
        Equal => assert(true),
        _ => assert(false)
    }
}

@test
func test_raw_mut_ptr_eq() {
    let p1: RawMutPtr[I32] = RawMutPtr::from_addr(500)
    let p2: RawMutPtr[I32] = RawMutPtr::from_addr(500)
    assert(p1.eq(ref p2))
}

@test
func test_nonnull_eq() {
    let ptr1: RawMutPtr[I32] = RawMutPtr::from_addr(1000)
    let ptr2: RawMutPtr[I32] = RawMutPtr::from_addr(1000)
    let nn1: NonNull[I32] = NonNull::new_unchecked(ptr1)
    let nn2: NonNull[I32] = NonNull::new_unchecked(ptr2)
    assert(nn1.eq(ref nn2))
}

// ============================================================================
// Pointer Hash Tests
// ============================================================================

@test
func test_raw_ptr_hash() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1234)
    let p2: RawPtr[I32] = RawPtr::from_addr(1234)
    assert_eq(p1.hash(), p2.hash())
    assert_eq(p1.hash(), 1234)
}

@test
func test_raw_ptr_hash_different() {
    let p1: RawPtr[I32] = RawPtr::from_addr(1000)
    let p2: RawPtr[I32] = RawPtr::from_addr(2000)
    assert(p1.hash() != p2.hash())
}

@test
func test_raw_mut_ptr_hash() {
    let p: RawMutPtr[I32] = RawMutPtr::from_addr(5678)
    assert_eq(p.hash(), 5678)
}

@test
func test_nonnull_hash() {
    let ptr: RawMutPtr[I32] = RawMutPtr::from_addr(9999)
    let nn: NonNull[I32] = NonNull::new_unchecked(ptr)
    assert_eq(nn.hash(), 9999)
}

// ============================================================================
// Pointer Arithmetic Chain Tests
// ============================================================================

@test
func test_ptr_arithmetic_chain() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(100)
    let result: RawPtr[I32] = ptr.add(5).sub(2).add(1)
    // 100 + 5*4 - 2*4 + 1*4 = 100 + 20 - 8 + 4 = 116
    assert_eq(result.addr(), 116)
}

@test
func test_mut_ptr_arithmetic_chain() {
    let ptr: RawMutPtr[I64] = RawMutPtr::from_addr(0)
    let result: RawMutPtr[I64] = ptr.add(10).sub(3)
    // 0 + 10*8 - 3*8 = 80 - 24 = 56
    assert_eq(result.addr(), 56)
}

// ============================================================================
// Null Pointer Safety Tests
// ============================================================================

@test
func test_null_is_null() {
    let ptr: RawPtr[I32] = RawPtr::null()
    assert(ptr.is_null())
    assert_eq(ptr.addr(), 0)
}

@test
func test_zero_addr_is_null() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(0)
    assert(ptr.is_null())
}

@test
func test_nonzero_addr_is_not_null() {
    let ptr: RawPtr[I32] = RawPtr::from_addr(1)
    assert(ptr.is_null() == false)
}
