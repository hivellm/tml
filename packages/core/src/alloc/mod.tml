//! Memory allocation APIs.
//!
//! This module provides the core memory allocation primitives for TML.

// Re-export submodules (the module loader will load all .tml files in this directory)
pub mod layout
pub mod global

// ============================================================================
// AllocError
// ============================================================================

/// The error type for allocation failure.
pub type AllocError {}

impl AllocError {
    /// Creates a new `AllocError`.
    pub func new() -> AllocError {
        return AllocError {}
    }

    pub func to_string(this) -> Str {
        return "memory allocation failed"
    }

    pub func debug_string(this) -> Str {
        return "AllocError"
    }
}

// ============================================================================
// Layout (simple version without lowlevel intrinsics)
// ============================================================================

/// Describes the memory layout of a type: its size and alignment.
pub type Layout {
    size: I64,
    align: I64
}

impl Layout {
    /// Creates a layout from explicit size and alignment values.
    pub func from_size_align(size: I64, align: I64) -> Outcome[Layout, LayoutError] {
        // Check that align is a power of two and non-zero
        if align <= 0 or (align & (align - 1)) != 0 {
            return Err(LayoutError::new())
        }

        // Check that size is valid
        if size < 0 {
            return Err(LayoutError::new())
        }

        return Ok(Layout { size: size, align: align })
    }

    /// Creates a layout from size and alignment without validation.
    pub func from_size_align_unchecked(size: I64, align: I64) -> Layout {
        return Layout { size: size, align: align }
    }

    /// Returns the size of this layout in bytes.
    pub func size(this) -> I64 {
        return this.size
    }

    /// Returns the alignment of this layout in bytes.
    pub func align(this) -> I64 {
        return this.align
    }

    /// Returns the padding needed to align to this layout.
    pub func padding_needed_for(this, len: I64) -> I64 {
        let a: I64 = this.align
        let len_rounded_up: I64 = (len + a - 1) / a * a
        return len_rounded_up - len
    }

    /// Returns a layout with the size padded to alignment.
    pub func pad_to_align(this) -> Outcome[Layout, LayoutError] {
        let new_size: I64 = this.size + this.padding_needed_for(this.size)
        return Layout::from_size_align(new_size, this.align)
    }
}

// ============================================================================
// LayoutError
// ============================================================================

/// Error for invalid layout parameters.
pub type LayoutError {}

impl LayoutError {
    pub func new() -> LayoutError {
        return LayoutError {}
    }

    pub func to_string(this) -> Str {
        return "invalid layout parameters"
    }

    pub func debug_string(this) -> Str {
        return "LayoutError"
    }
}
