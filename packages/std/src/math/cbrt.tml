// Cube root implementation

use abs

// Cube root using Newton-Raphson method
pub func cbrt(x: F64) -> F64 {
    if x == 0.0 then return 0.0
    if x == 1.0 then return 1.0
    if x == -1.0 then return -1.0

    // Handle negative numbers
    let negative: Bool = x < 0.0
    let abs_x: F64 = abs(x)

    // Initial guess
    let mut guess: F64 = abs_x / 3.0
    let mut prev: F64 = 0.0

    // Newton-Raphson: x_{n+1} = (2*x_n + S/x_n^2) / 3
    let mut iterations: I32 = 0
    loop {
        if iterations >= 30 then break

        let guess_sq: F64 = guess * guess
        let next: F64 = (2.0 * guess + abs_x / guess_sq) / 3.0

        // Check for convergence
        let diff: F64 = next - prev
        let abs_diff: F64 = if diff < 0.0 then -diff else diff

        if abs_diff < 0.000001 then break

        prev = guess
        guess = next
        iterations = iterations + 1
    }

    if negative then -guess else guess
}

pub func cbrt_i32(n: I32) -> I32 {
    if n == 0 then return 0
    if n == 1 then return 1
    if n == -1 then return -1

    let negative: Bool = n < 0
    let abs_n: I32 = if n < 0 then -n else n

    // Binary search for cube root
    let mut low: I32 = 0
    let mut high: I32 = abs_n

    loop {
        if low > high then break

        let mid: I32 = (low + high) / 2
        let cube: I32 = mid * mid * mid

        if cube == abs_n then {
            return if negative then -mid else mid
        }

        if cube < abs_n then {
            low = mid + 1
        } else {
            high = mid - 1
        }
    }

    if negative then -high else high
}
