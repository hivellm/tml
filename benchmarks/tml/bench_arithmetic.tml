// Benchmark: Basic Arithmetic Operations (No Allocation)
// Category: arithmetic
// Description: Tests pure computation speed

use std::time::{Instant, Duration}

// Benchmark 1: Integer addition loop
func bench_int_add(iterations: I64) -> I64 {
    let mut sum: I64 = 0
    for i in 0 to iterations {
        sum += i
    }
    return sum
}

// Benchmark 2: Integer multiplication
func bench_int_mul(iterations: I64) -> I64 {
    let mut product: I64 = 1
    for i in 1 through iterations {
        product = (product * i) % 1000000007
    }
    return product
}

// Benchmark 3: Mixed arithmetic
func bench_mixed_ops(iterations: I64) -> I64 {
    let mut a: I64 = 1
    let mut b: I64 = 2
    let mut c: I64 = 3
    for _ in 0 to iterations {
        a = (a + b) * c % 1000000007
        b = (b * c + a) % 1000000007
        c = (c + a - b) % 1000000007
        if c < 0 {
            c += 1000000007
        }
    }
    return a + b + c
}

// Benchmark 4: Fibonacci iterative
func bench_fibonacci(n: I64) -> I64 {
    if n <= 1 {
        return n
    }
    let mut a: I64 = 0
    let mut b: I64 = 1
    for _ in 2 through n {
        let temp: I64 = a + b
        a = b
        b = temp
    }
    return b
}

// Benchmark 5: Prime counting
func bench_count_primes(limit: I64) -> I64 {
    let mut count: I64 = 0
    for n in 2 through limit {
        let mut is_prime: Bool = true
        let mut i: I64 = 2
        loop {
            if i * i > n {
                break
            }
            if n % i == 0 {
                is_prime = false
                break
            }
            i++
        }
        if is_prime {
            count++
        }
    }
    return count
}

func run_benchmark_int_add(name: Str, arg: I64, runs: I64) {
    let _: I64 = black_box_i64(bench_int_add(arg))  // Warmup
    let mut total_ms: F64 = 0.0
    for _ in 0 to runs {
        let start: Instant = Instant::now()
        let _: I64 = black_box_i64(bench_int_add(arg))
        total_ms += Duration::as_millis_f64(Instant::elapsed(start))
    }
    println("{}: {.3} ms (avg of {} runs)", name, total_ms / 3.0, runs)
}

func run_benchmark_int_mul(name: Str, arg: I64, runs: I64) {
    let _: I64 = black_box_i64(bench_int_mul(arg))  // Warmup
    let mut total_ms: F64 = 0.0
    for _ in 0 to runs {
        let start: Instant = Instant::now()
        let _: I64 = black_box_i64(bench_int_mul(arg))
        total_ms += Duration::as_millis_f64(Instant::elapsed(start))
    }
    println("{}: {.3} ms (avg of {} runs)", name, total_ms / 3.0, runs)
}

func run_benchmark_mixed_ops(name: Str, arg: I64, runs: I64) {
    let _: I64 = black_box_i64(bench_mixed_ops(arg))  // Warmup
    let mut total_ms: F64 = 0.0
    for _ in 0 to runs {
        let start: Instant = Instant::now()
        let _: I64 = black_box_i64(bench_mixed_ops(arg))
        total_ms += Duration::as_millis_f64(Instant::elapsed(start))
    }
    println("{}: {.3} ms (avg of {} runs)", name, total_ms / 3.0, runs)
}

func run_benchmark_fibonacci(name: Str, arg: I64, runs: I64) {
    let _: I64 = black_box_i64(bench_fibonacci(arg))  // Warmup
    let mut total_ms: F64 = 0.0
    for _ in 0 to runs {
        let start: Instant = Instant::now()
        let _: I64 = black_box_i64(bench_fibonacci(arg))
        total_ms += Duration::as_millis_f64(Instant::elapsed(start))
    }
    println("{}: {.3} ms (avg of {} runs)", name, total_ms / 3.0, runs)
}

func run_benchmark_count_primes(name: Str, arg: I64, runs: I64) {
    let _: I64 = black_box_i64(bench_count_primes(arg))  // Warmup
    let mut total_ms: F64 = 0.0
    for _ in 0 to runs {
        let start: Instant = Instant::now()
        let _: I64 = black_box_i64(bench_count_primes(arg))
        total_ms += Duration::as_millis_f64(Instant::elapsed(start))
    }
    println("{}: {.3} ms (avg of {} runs)", name, total_ms / 3.0, runs)
}

func main() -> I32 {
    println("=== TML Arithmetic Benchmarks ===")
    println("")

    let runs: I64 = 3

    run_benchmark_int_add("int_add_1M", 1000000, runs)
    run_benchmark_int_mul("int_mul_100K", 100000, runs)
    run_benchmark_mixed_ops("mixed_ops_100K", 100000, runs)
    run_benchmark_fibonacci("fibonacci_10K", 10000, runs)
    run_benchmark_count_primes("count_primes_1K", 1000, runs)

    println("")
    println("Done.")
    return 0
}
