// TML Example 09: Modules and Imports
// Demonstrates the module system

// ============================================
// MODULE DECLARATION
// ============================================

// Every file starts with a module declaration
mod my_app

// ============================================
// IMPORTS
// ============================================

// use entire module
use std::io
use std::collections

// use specific items
use std::fs { read_file, write_file }
use std::math { sin, cos, PI }

// use with alias
use std::collections.HashMap as Map
use std::time as t

// use all public items (use sparingly)
use std::string.*

// Relative imports (within same package)
use .utils           // sibling module
use ..common.types   // parent's sibling

// ============================================
// VISIBILITY
// ============================================

// Private by default (only accessible within module)
func helper() -> I32 {
    return 42
}

// Public - accessible from other modules
pub func process() -> String {
    return "processed"
}

// pub type
pub type Config {
    public name: String,        // public field
    private secret: String,     // private field
    public max_size: U64,
}

// pub behavior
pub behavior Processor {
    func process(this, data: String) -> String
}

// ============================================
// MODULE STRUCTURE EXAMPLE
// ============================================

// File: src/lib.tml (root module)
mod mylib

public use .math      // re-export submodule
public use .utils

// File: src/math.tml
mod mylib.math

pub func add(a: I32, b: I32) -> I32 {
    return a + b
}

pub func multiply(a: I32, b: I32) -> I32 {
    return a * b
}

// Private helper
func validate(n: I32) -> Bool {
    return n >= 0
}

// File: src/utils.tml
mod mylib.utils

pub func format_number(n: I32) -> String {
    return n.to_string()
}

// ============================================
// PACKAGE STRUCTURE
// ============================================

// Package manifest: tml.toml
// [package]
// name = "my_app"
// version = "1.0.0"
//
// [dependencies]
// std = "1.0"
// json = "2.3"
// http = { version = "1.5", features = ["tls"] }

// ============================================
// CONDITIONAL COMPILATION
// ============================================

// Platform-specific code
@when(platform = "windows")
func get_home() -> String {
    return env("USERPROFILE")
}

@when(platform = "linux")
func get_home() -> String {
    return env("HOME")
}

// Feature flags
@when(feature = "logging")
func log(msg: String) {
    println("[LOG] " + msg)
}

@when(not(feature = "logging"))
func log(msg: String) {
    // No-op when logging disabled
}

// ============================================
// NAMESPACING
// ============================================

// Nested modules for organization
mod my_app.database

pub type Connection {
    host: String,
    port: U16,
}

pub func connect(host: String, port: U16) -> Outcome[Connection, String] {
    return Ok(Connection { host, port })
}

mod my_app.database.queries

use ..Connection

pub func execute(conn: ref Connection, sql: String) -> Outcome[List[Row], String] {
    // ...
    return Ok([])
}

pub type Row {
    data: Map[String, String],
}

// ============================================
// MAIN MODULE EXAMPLE
// ============================================

mod main

use my_app.database { connect }
use my_app.database.queries { execute }

pub func main() {
    // Using imported items
    let conn = connect("localhost", 5432)

    when conn {
        Ok(c) -> {
            let result = execute(ref c, "SELECT * FROM users")
            println("Query executed")
        },
        Err(e) -> println("Connection failed: " + e),
    }

    // Fully qualified access
    let pi = std.math.PI
    let map = std.collections.HashMap.new()

    // Using aliased imports
    let now = t.now()
    let cache: Map[String, I32] = Map.new()
}
