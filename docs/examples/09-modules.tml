// TML Example 09: Modules and Imports
// Demonstrates the module system

// ============================================
// MODULE DECLARATION
// ============================================

// Every file starts with a module declaration
mod my_app

// ============================================
// IMPORTS
// ============================================

// use entire module
use std::io
use std::collections

// use specific items
use std::file::{read_file, write_file}
use std::math::{sin, cos, PI}

// use with alias
use std::collections::HashMap
use std::time

// use all public items (use sparingly)
use std::str::*

// Relative imports (within same package)
use .utils           // sibling module
use ..common.types   // parent's sibling

// ============================================
// VISIBILITY
// ============================================

// Private by default (only accessible within module)
func helper() -> I32 {
    return 42
}

// Public - accessible from other modules
pub func process() -> Str {
    return "processed"
}

// pub type
pub type Config {
    pub name: Str,              // public field
    secret: Str,                // private field
    pub max_size: U64,
}

// pub behavior
pub behavior Processor {
    func process(this, data: Str) -> Str
}

// ============================================
// MODULE STRUCTURE EXAMPLE
// ============================================

// File: src/lib.tml (root module)
mod mylib

pub use .math      // re-export submodule
pub use .utils

// File: src/math.tml
mod mylib.math

pub func add(a: I32, b: I32) -> I32 {
    return a + b
}

pub func multiply(a: I32, b: I32) -> I32 {
    return a * b
}

// Private helper
func validate(n: I32) -> Bool {
    return n >= 0
}

// File: src/utils.tml
mod mylib.utils

pub func format_number(n: I32) -> Str {
    return n.to_string()
}

// ============================================
// PACKAGE STRUCTURE
// ============================================

// Package manifest: tml.toml
// [package]
// name = "my_app"
// version = "1.0.0"
//
// [dependencies]
// std = "1.0"
// json = "2.3"
// http = { version = "1.5", features = ["tls"] }

// ============================================
// CONDITIONAL COMPILATION
// ============================================

// Platform-specific code
@when(platform = "windows")
func get_home() -> Str {
    return env("USERPROFILE")
}

@when(platform = "linux")
func get_home() -> Str {
    return env("HOME")
}

// Feature flags
@when(feature = "logging")
func log(msg: Str) {
    println("[LOG] " + msg)
}

@when(not(feature = "logging"))
func log(msg: Str) {
    // No-op when logging disabled
}

// ============================================
// NAMESPACING
// ============================================

// Nested modules for organization
mod my_app.database

pub type Connection {
    host: Str,
    port: U16,
}

pub func connect(host: Str, port: U16) -> Outcome[Connection, Str] {
    return Ok(Connection { host, port })
}

mod my_app.database.queries

use ..Connection

pub func execute(conn: ref Connection, sql: Str) -> Outcome[List[Row], Str] {
    // ...
    return Ok([])
}

pub type Row {
    data: HashMap[Str, Str],
}

// ============================================
// MAIN MODULE EXAMPLE
// ============================================

mod main

use my_app::database::{connect}
use my_app::database::queries::{execute}

pub func main() {
    // Using imported items
    let conn = connect("localhost", 5432)

    when conn {
        Ok(c) -> {
            let result = execute(ref c, "SELECT * FROM users")
            println("Query executed")
        },
        Err(e) -> println("Connection failed: " + e),
    }

    // Fully qualified access
    let pi = std::math::PI
    let map = HashMap::new(16)

    // Using module imports
    let now = time::now()
    let cache: HashMap[Str, I32] = HashMap::new(16)
}
